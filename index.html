<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Shipment Operations Dashboard</title>
    <!-- SheetJS for Excel file reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Leaflet for mapping -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <!-- Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    <!-- Chart.js for analytics -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Leaflet Control Geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        
        /* Format warning modal */
        .format-warning-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .format-warning-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .panavision-logo {
            display: block;
            margin: 0 auto 30px;
            height: 60px;
        }
        
        .warning-header {
            background-color: #ff9800;
            color: white;
            padding: 15px 20px;
            margin: -40px -40px 30px;
            border-radius: 15px 15px 0 0;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .format-example {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e0e0e0;
        }
        
        .format-example h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .required-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .column-item {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        
        .understand-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: all 0.3s;
        }
        
        .understand-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .dashboard-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background-color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        h1 {
            font-size: 28px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        h2 {
            font-size: 20px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .sidebar h2 {
            color: #ecf0f1;
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #34495e;
        }
        
        .upload-section {
            background-color: #34495e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .file-input-wrapper:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        #processBtn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
            width: 100%;
        }
        
        #processBtn:hover:not(:disabled) {
            background-color: #229954;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        #processBtn:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            transform: none;
        }
        
        .filter-section {
            background-color: #34495e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: #bdc3c7;
            font-weight: 500;
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            background-color: #2c3e50;
            color: white;
            font-size: 14px;
        }
        
        .filter-group input::placeholder {
            color: #95a5a6;
        }
        
        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s;
            border-left: 4px solid transparent;
            position: relative;
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .stat-card.primary { border-left-color: #3498db; }
        .stat-card.success { border-left-color: #27ae60; }
        .stat-card.warning { border-left-color: #f39c12; }
        .stat-card.danger { border-left-color: #e74c3c; }
        .stat-card.info { border-left-color: #9b59b6; }
        
        .stat-card h3 {
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            color: #2c3e50;
            font-size: 32px;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .stat-card .year-selector {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 12px;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #f8f9fa;
        }
        
        .time-series-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .time-series-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .close-modal:hover {
            color: #2c3e50;
        }
        
        #map {
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            background-color: white;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: 350px;
        }
        
        .chart-card h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .chart-card canvas {
            max-height: 280px;
        }
        
        .data-table-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #229954;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        .results-table {
            overflow-x: auto;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .results-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .results-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }
        
        .results-table th:hover {
            background-color: #e9ecef;
        }
        
        .results-table th.sorted-asc::after {
            content: " ‚Üë";
            color: #3498db;
        }
        
        .results-table th.sorted-desc::after {
            content: " ‚Üì";
            color: #3498db;
        }
        
        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .results-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .results-table tr.selected {
            background-color: #e3f2fd;
        }
        
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loader-content {
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            max-width: 500px;
        }
        
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .co2-fact {
            color: #27ae60;
            font-size: 16px;
            margin: 20px 0;
            line-height: 1.6;
            padding: 15px;
            background-color: #e8f8f5;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
        }
        
        .created-by {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 20px;
            font-style: italic;
        }
        
        .error-message {
            color: #e74c3c;
            background-color: #fadbd8;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .success-message {
            color: #27ae60;
            background-color: #d5f4e6;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .leaflet-popup-content {
            min-width: 300px;
            max-width: 400px;
        }
        
        .popup-content {
            padding: 10px;
        }
        
        .popup-content h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .popup-content .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 15px;
            font-size: 14px;
        }
        
        .popup-content .label {
            font-weight: 600;
            color: #7f8c8d;
        }
        
        .popup-content .value {
            color: #2c3e50;
        }
        
        .legend {
            background-color: white;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .legend h4 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .advanced-filters {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #34495e;
        }
        
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        
        .filter-tag {
            background-color: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .shipment-heatmap {
            position: absolute;
            top: 80px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3498db;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        /* Recommendation Widget Styles */
        .recommendation-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .recommendation-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .recommendation-card h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .recommendation-card .amount {
            font-size: 28px;
            font-weight: bold;
        }

        .route-recommendation {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .route-recommendation.savings {
            border-left-color: #27ae60;
        }

        .route-recommendation.no-savings {
            border-left-color: #e74c3c;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .route-header h5 {
            margin: 0;
            color: #2c3e50;
        }

        .savings-badge {
            background: #27ae60;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .no-savings-badge {
            background: #e74c3c;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .comparison-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
            font-size: 14px;
        }

        .comparison-table th {
            background: #ecf0f1;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }

        .comparison-table td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
        }

        .comparison-table tr.highlight {
            background: #e8f8f5;
            font-weight: bold;
        }

        .recommendation-footer {
            margin-top: 20px;
            padding: 20px;
            background: #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            color: #7f8c8d;
        }


    </style>
</head>
<body>
    <!-- Format Warning Modal -->
    <div class="format-warning-modal" id="formatWarningModal">
        <div class="format-warning-content">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 80'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='48' font-weight='bold' fill='%23000000'%3EPANAVISION%3C/text%3E%3C/svg%3E" alt="Panavision" class="panavision-logo">
            
            <div class="warning-header">
                <span>‚ö†Ô∏è</span>
                <span>WARNING: Your Excel file needs to be in this format</span>
            </div>
            
            <div class="format-example">
                <h4>Required Excel Format Example:</h4>
                <p>Your Excel file must contain the following columns (exact names required):</p>
                <div class="required-columns">
                    <div class="column-item">üìã Unique identifier</div>
                    <div class="column-item">üìÖ Collection Date</div>
                    <div class="column-item">üìç Collection Area Name</div>
                    <div class="column-item">üìç Delivery Area Name</div>
                    <div class="column-item">üåç Origin Country</div>
                    <div class="column-item">üåç Destination Country</div>
                    <div class="column-item">üöö Transport Mode</div>
                    <div class="column-item">üì¶ Shipper</div>
                    <div class="column-item">üå± Emission type by shipper mode</div>
                    <div class="column-item">üìä Emission factor of emission type</div>
                    <div class="column-item">‚öñÔ∏è Weight</div>
                    <div class="column-item">üí∞ Cost of shipment</div>
                </div>
                
                <p style="margin-top: 20px; color: #7f8c8d;">
                    <strong>Note:</strong> The dashboard will automatically calculate CO2 emissions, distances, and efficiency metrics based on your data.
                </p>
            </div>
            
            <button class="understand-btn" onclick="closeFormatWarning()">I Understand - Continue</button>
        </div>
    </div>

    <!-- Time Series Modal -->
    <div class="time-series-modal" id="timeSeriesModal">
        <div class="time-series-content">
            <span class="close-modal" onclick="closeTimeSeriesModal()">&times;</span>
            <h2 id="timeSeriesTitle">Time Series Analysis</h2>
            <canvas id="timeSeriesChart" style="width: 100%; height: 400px;"></canvas>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="sidebar">
            <h2>üìä Shipment Dashboard</h2>
            
            <div class="upload-section">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".xlsx,.xls">
                    <span>üìÅ Choose Excel File</span>
                </div>
                <div id="fileName" style="margin-top: 10px; font-size: 12px; color: #bdc3c7;"></div>
                <button id="processBtn" disabled>Process Data</button>
            </div>
            
            <div class="filter-section">
                <h2>üîç Filters</h2>
                
                <div class="filter-group">
                    <label>Search (ID, Location, Shipper)</label>
                    <input type="text" id="globalSearch" placeholder="Enter search term...">
                </div>
                
                <div class="filter-group">
                    <label>Location/Area Name Search</label>
                    <select id="searchCountry" style="margin-bottom: 8px;">
                        <option value="">Select Country First</option>
                    </select>
                    <input type="text" id="locationCodeSearch" placeholder="Shipment area name (eg:Bath)" disabled>
                    <div id="postalCodeHint" style="font-size: 11px; color: #95a5a6; margin-top: 5px; display: none;">
                        <span id="hintText"></span>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label>Origin Country</label>
                    <select id="originCountryFilter">
                        <option value="">All Countries</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Destination Country</label>
                    <select id="destCountryFilter">
                        <option value="">All Countries</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Transport Mode</label>
                    <select id="transportModeFilter">
                        <option value="">All Modes</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Shipper</label>
                    <select id="shipperFilter">
                        <option value="">All Shippers</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Date Range</label>
                    <div class="date-range">
                        <input type="date" id="startDate">
                        <input type="date" id="endDate">
                    </div>
                </div>
                
                <div class="advanced-filters">
                    <div class="filter-group">
                        <label>Min Weight (kg)</label>
                        <input type="number" id="minWeight" placeholder="0">
                    </div>
                    
                    <div class="filter-group">
                        <label>Max Weight (kg)</label>
                        <input type="number" id="maxWeight" placeholder="No limit">
                    </div>

                    <div id="backendStatus" style="display: none; position: fixed; top: 10px; right: 10px; padding: 10px 20px; border-radius: 5px; z-index: 1000;">
                        <span id="backendStatusText"></span>
                    </div>
                    
                    <div class="filter-group">
                        <label>Min Cost (¬£)</label>
                        <input type="number" id="minCost" placeholder="0">
                    </div>
                    
                    <div class="filter-group">
                        <label>Max Cost (¬£)</label>
                        <input type="number" id="maxCost" placeholder="No limit">
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="resetFilters()">
                    Reset All Filters
                </button>
                
                <div class="filter-tags" id="activeFilters"></div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h1>Shipment Operations Intelligence</h1>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn btn-success" onclick="exportToCSV()" style="padding: 12px 30px; font-size: 16px;">
                        üìä Export Full Analysis CSV
                    </button>
                    <button class="btn btn-primary" onclick="analyzeRouteOptimization()" id="analyzeBtn" style="padding: 12px 30px; font-size: 16px;">
                        üí° Analyze Cost Optimization
                    </button>
                </div>
            </div>
            
        <!-- Recommendation Results Modal -->
        <div id="recommendationResults" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 9999; justify-content: center; align-items: center;">
            <div style="background: white; max-width: 1200px; width: 90%; max-height: 90vh; overflow-y: auto; margin: auto; border-radius: 10px; padding: 30px; position: relative;">
                <button onclick="closeRecommendations()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #7f8c8d;">&times;</button>
                <h2 style="margin-bottom: 20px;">üí° Cost Optimization Recommendations</h2>
                
                <!-- Route Selection for Analysis -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #e0e0e0;">
                    <h3 style="margin-top: 0;">üìç Select Routes for Cost Analysis</h3>
                    <p style="color: #7f8c8d; margin-bottom: 15px;">Select specific routes to analyze for cost optimization opportunities</p>
                    <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Origin Country</label>
                            <select id="routeOriginSelect" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">All Origins</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Destination Country</label>
                            <select id="routeDestSelect" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="">All Destinations</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="analyzeSelectedRoutes()" style="padding: 10px 30px;">
                            üîç Analyze Selected Routes
                        </button>
                    </div>
                    <div id="selectedRoutesInfo" style="margin-top: 15px; display: none;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; border-left: 4px solid #3498db;">
                            <strong>Selected Route:</strong> <span id="selectedRouteText"></span><br>
                            <small>Click "Analyze Selected Routes" to check optimization opportunities for this specific route</small>
                        </div>
                    </div>
                </div>
                
                <div class="loader" id="recommendationLoader" style="position: relative; background: transparent; display: none;">
                    <div class="loader-spinner"></div>
                    <div style="margin-top: 10px;">Analyzing routes and fetching competitive rates...</div>
                </div>
                <div id="recommendationContent"></div>
            </div>
        </div>

            <div class="content-area">
                <div class="loader" id="loader">
                    <div class="loader-content">
                        <div class="loader-spinner"></div>
                        <div id="loaderText">Processing your data...</div>
                        <div id="co2Fact" class="co2-fact"></div>
                        <div class="created-by">This dashboard is created by Imperial students with Claude for Panavision</div>
                    </div>
                </div>
                
                <div id="errorContainer"></div>
                <div id="successContainer"></div>
                
                <div id="results" style="display: none;">
                    <div class="stats-grid" id="statsContainer"></div>
                    
                    <div class="legend">
                        <h4>Transport Mode Colors</h4>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #ff4444;"></div>
                                <span>Air</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #4444ff;"></div>
                                <span>Sea</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #44ff44;"></div>
                                <span>Road</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #ff44ff;"></div>
                                <span>Rail</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #ffaa44;"></div>
                                <span>Other</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="position: relative;">
                        <div id="map"></div>
                        <div class="shipment-heatmap">
                            <div class="toggle-switch">
                                <span>Show Routes</span>
                                <label class="switch">
                                    <input type="checkbox" id="toggleRoutes" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="toggle-switch">
                                <span>Cluster Markers</span>
                                <label class="switch">
                                    <input type="checkbox" id="toggleClusters" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="charts-container">
                        <div class="chart-card">
                            <h3>Shipments by Transport Mode</h3>
                            <canvas id="transportChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>Top 10 Routes by Volume</h3>
                            <canvas id="routesChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>Monthly Shipment Trends</h3>
                            <canvas id="trendsChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>Cost vs CO2 Emissions Analysis</h3>
                            <canvas id="scatterChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <div class="table-controls">
                            <div class="search-box">
                                <input type="text" id="tableSearch" placeholder="Search in table...">
                            </div>
                            <div>
                                <span id="recordCount" style="color: #7f8c8d; margin-right: 15px;"></span>
                            </div>
                        </div>
                        
                        <div class="results-table">
                            <table id="dataTable">
                                <thead>
                                    <tr>
                                        <th onclick="sortTable(0)">ID</th>
                                        <th onclick="sortTable(1)">Date</th>
                                        <th onclick="sortTable(2)">Origin</th>
                                        <th onclick="sortTable(3)">Destination</th>
                                        <th onclick="sortTable(4)">Mode</th>
                                        <th onclick="sortTable(5)">Shipper</th>
                                        <th onclick="sortTable(6)">Weight (kg)</th>
                                        <th onclick="sortTable(7)">Cost (¬£)</th>
                                        <th onclick="sortTable(8)">CO2 (kg)</th>
                                        <th onclick="sortTable(9)">Distance (km)</th>
                                        <th onclick="sortTable(10)">Cost/km</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let shipmentData = [];
        let filteredData = [];
        let markers = [];
        let polylines = [];
        let markerClusterGroup;
        const geocodeCache = {};
        let charts = {};
        let sortColumn = -1;
        let sortDirection = 'asc';
        let geocoder;
        let timeSeriesChart = null;
        let currentStatYear = null;
        
        // Transport mode colors (consistent across all charts)
        const transportColors = {
            'air': '#ff4444',
            'sea': '#4444ff',
            'road': '#44ff44',
            'rail': '#ff44ff',
            'other': '#ffaa44'
        };
        
        // CO2 facts for loading screen
        const co2Facts = [
            "üåç Did you know? The transportation sector accounts for about 24% of global CO2 emissions.",
            "‚úàÔ∏è Air freight produces about 47 times more CO2 per ton-kilometer than sea freight.",
            "üö¢ Shipping by sea is the most carbon-efficient mode of transport for long distances.",
            "üöÇ Rail transport produces 75% less CO2 than road transport for the same distance.",
            "üì¶ Optimizing shipment routes can reduce CO2 emissions by up to 30%.",
            "üå± Every ton of CO2 saved in logistics helps combat climate change.",
            "üöö Electric trucks can reduce CO2 emissions by up to 63% compared to diesel trucks.",
            "üåä The shipping industry aims to reduce CO2 emissions by 50% by 2050.",
            "üìä Real-time tracking can help reduce empty miles and cut emissions by 15-20%.",
            "‚ôªÔ∏è Sustainable packaging can reduce shipment weight and lower CO2 emissions."
        ];
        
        // Postal code mappings from Excel file
        const POSTAL_CODE_MAPPINGS = {
            "United Kingdom": {
                "AB": {"name": "Aberdeen", "region": "Scotland"},
                "AL": {"name": "St. Albans", "region": "East of England"},
                "B": {"name": "Birmingham", "region": "West Midlands"},
                "BA": {"name": "Bath", "region": "South West"},
                "BB": {"name": "Blackburn", "region": "North West"},
                "BD": {"name": "Bradford", "region": "North West"},
                "BH": {"name": "Bournemouth", "region": "South West"},
                "BL": {"name": "Bolton", "region": "North West"},
                "BN": {"name": "Brighton", "region": "South East"},
                "BR": {"name": "Bromley", "region": "Greater London"},
                "BS": {"name": "Bristol", "region": "South West"},
                "BT": {"name": "Belfast", "region": "Northern Ireland"},
                "CA": {"name": "Carlisle", "region": "North West"},
                "CB": {"name": "Cambridge", "region": "East of England"},
                "CF": {"name": "Cardiff", "region": "Wales"},
                "CH": {"name": "Chester", "region": "North West"},
                "CM": {"name": "Chelmsford", "region": "East of England"},
                "CO": {"name": "Colchester", "region": "East of England"},
                "CR": {"name": "Croydon", "region": "Greater London"},
                "CT": {"name": "Canterbury", "region": "South East"},
                "CV": {"name": "Coventry", "region": "West Midlands"},
                "CW": {"name": "Crewe", "region": "North West"},
                "DA": {"name": "Dartford", "region": "South East"},
                "DD": {"name": "Dundee", "region": "Scotland"},
                "DE": {"name": "Derby", "region": "East Midlands"},
                "DG": {"name": "Dumfries", "region": "Scotland"},
                "DH": {"name": "Durham", "region": "North East"},
                "DL": {"name": "Darlington", "region": "North East"},
                "DN": {"name": "Doncaster", "region": "South West"},
                "DT": {"name": "Dorchester", "region": "South West"},
                "DY": {"name": "Dudley", "region": "West Midlands"},
                "E": {"name": "East London", "region": "Greater London"},
                "EC": {"name": "East Central London", "region": "Greater London"},
                "EH": {"name": "Edinburgh", "region": "Scotland"},
                "EN": {"name": "Enfield", "region": "Greater London"},
                "EX": {"name": "Exeter", "region": "South West"},
                "FK": {"name": "Falkirk", "region": "Scotland"},
                "FY": {"name": "Blackpool", "region": "North West"},
                "G": {"name": "Glasgow", "region": "Scotland"},
                "GL": {"name": "Gloucester", "region": "South West"},
                "GU": {"name": "Guildford", "region": "South East"},
                "GY": {"name": "Guernsey", "region": "Channel Islands"},
                "HA": {"name": "Harrow", "region": "Greater London"},
                "HD": {"name": "Huddersfield", "region": "North West"},
                "HG": {"name": "Harrogate", "region": "North West"},
                "HP": {"name": "Hemel", "region": "East of England"},
                "HR": {"name": "Hereford", "region": "West Midlands"},
                "HS": {"name": "Outer Hebrides", "region": "Scotland"},
                "HU": {"name": "Hull", "region": "North West"},
                "HX": {"name": "Halifax", "region": "North West"},
                "IG": {"name": "Ilford", "region": "Greater London"},
                "IM": {"name": "Isle of Man", "region": "Isle of Man"},
                "IP": {"name": "Ipswich", "region": "East of England"},
                "IV": {"name": "Inverness", "region": "Scotland"},
                "JE": {"name": "Jersey", "region": "Channel Islands"},
                "KA": {"name": "Kilmarnock", "region": "Scotland"},
                "KT": {"name": "Kingston upon Thames", "region": "Greater London"},
                "KW": {"name": "Kirkwall", "region": "Scotland"},
                "KY": {"name": "Kirkcaldy", "region": "Scotland"},
                "L": {"name": "Liverpool", "region": "North West"},
                "LA": {"name": "Lancaster", "region": "North West"},
                "LD": {"name": "Llandrindod Wells", "region": "Wales"},
                "LE": {"name": "Leicester", "region": "East Midlands"},
                "LL": {"name": "Llandudno", "region": "Wales"},
                "LN": {"name": "Lincoln", "region": "East Midlands"},
                "LS": {"name": "Leeds", "region": "North West"},
                "LU": {"name": "Luton", "region": "East of England"},
                "M": {"name": "Manchester", "region": "North West"},
                "ME": {"name": "Medway", "region": "South East"},
                "MK": {"name": "Milton Keynes", "region": "South East"},
                "ML": {"name": "Motherwell", "region": "Scotland"},
                "N": {"name": "North London", "region": "Greater London"},
                "NE": {"name": "Newcastle", "region": "North East"},
                "NG": {"name": "Nottingham", "region": "East Midlands"},
                "NN": {"name": "Northampton", "region": "West Midlands"},
                "NP": {"name": "Newport", "region": "Wales"},
                "NR": {"name": "Norwich", "region": "East of England"},
                "NW": {"name": "North West London", "region": "Greater London"},
                "OL": {"name": "Oldham", "region": "North West"},
                "OX": {"name": "Oxford", "region": "South East"},
                "PA": {"name": "Paisley", "region": "Scotland"},
                "PE": {"name": "Peterborough", "region": "East of England"},
                "PH": {"name": "Perth", "region": "Scotland"},
                "PL": {"name": "Plymouth", "region": "South West"},
                "PO": {"name": "Portsmouth", "region": "South East"},
                "PR": {"name": "Preston", "region": "North West"},
                "RG": {"name": "Reading", "region": "South East"},
                "RH": {"name": "Redhill", "region": "South East"},
                "RM": {"name": "Romford", "region": "Greater London"},
                "S": {"name": "Sheffield", "region": "North West"},
                "SA": {"name": "Swansea", "region": "Wales"},
                "SE": {"name": "South East London", "region": "Greater London"},
                "SG": {"name": "Stevenage", "region": "East England"},
                "SK": {"name": "Stockport", "region": "North West"},
                "SL": {"name": "Slough", "region": "South East"},
                "SM": {"name": "Sutton", "region": "Greater London"},
                "SN": {"name": "Swindon", "region": "South West"},
                "SO": {"name": "Southampton", "region": "South East"},
                "SP": {"name": "Salisbury", "region": "South West"},
                "SR": {"name": "Sunderland", "region": "North East"},
                "SS": {"name": "Southend-on-Sea", "region": "East of England"},
                "ST": {"name": "Stoke-on-Trent", "region": "West Midlands"},
                "SW": {"name": "South West London", "region": "Greater London"},
                "SY": {"name": "Shrewsbury", "region": "West Midlands"},
                "TA": {"name": "Taunton", "region": "South West"},
                "TD": {"name": "Berwick-upon-Tweed", "region": "Scotland"},
                "TF": {"name": "Telford", "region": "West Midlands"},
                "TN": {"name": "Tonbridge", "region": "South East"},
                "TQ": {"name": "Torquay", "region": "South West"},
                "TR": {"name": "Truro", "region": "South West"},
                "TS": {"name": "Middlesbrough", "region": "North East"},
                "TW": {"name": "Twickenham", "region": "Greater London"},
                "UB": {"name": "Southall", "region": "Greater London"},
                "W": {"name": "West London", "region": "Greater London"},
                "WA": {"name": "Warrington", "region": "North West"},
                "WC": {"name": "West Central London", "region": "Greater London"},
                "WD": {"name": "Watford", "region": "East of England"},
                "WF": {"name": "Wakefield", "region": "North West"},
                "WN": {"name": "Wigan", "region": "North West"},
                "WR": {"name": "Worcester", "region": "West Midlands"},
                "WS": {"name": "Walsall", "region": "West Midlands"},
                "WV": {"name": "Wolverhampton", "region": "West Midlands"},
                "YO": {"name": "York", "region": "North West"},
                "ZE": {"name": "Lerwick", "region": "Scotland"},
                "BX": {"name": "Non-geographic", "region": "Non-geographic"},
                "XX": {"name": "Non-geographic", "region": "Non-geographic"}
            },
            "UK": {},  // Will be populated below
            "UNITED KINGDOM": {}  // Will be populated below
        };
        
        // Copy mappings to UK variants
        POSTAL_CODE_MAPPINGS.UK = POSTAL_CODE_MAPPINGS["United Kingdom"];
        POSTAL_CODE_MAPPINGS["UNITED KINGDOM"] = POSTAL_CODE_MAPPINGS["United Kingdom"];
        
        // Required columns
        const REQUIRED_COLUMNS = [
            ['Unique identifier', 'Unique identifier'],
            ['Collection Date', 'Shipping Date'],
            ['Collection Area Name'],
            ['Delivery Area Name'],
            ['Origin Country'],
            ['Destination Country'],
            ['Transport Mode'],
            ['Shipper'],
            ['Emission type by shipper mode'],
            ['Emission factor of emission type'],
            ['Weight'],
            ['Cost of shipment']
        ];

        // Close format warning modal
        function closeFormatWarning() {
            document.getElementById('formatWarningModal').style.display = 'none';
        }

        // Show time series modal
        function showTimeSeriesModal(metric, title) {
            document.getElementById('timeSeriesTitle').textContent = title;
            document.getElementById('timeSeriesModal').style.display = 'flex';
            
            // Generate time series data
            const timeSeriesData = generateTimeSeriesData(metric);
            
            // Create time series chart
            const ctx = document.getElementById('timeSeriesChart').getContext('2d');
            
            if (timeSeriesChart) {
                timeSeriesChart.destroy();
            }
            
            timeSeriesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeSeriesData.labels,
                    datasets: [{
                        label: title,
                        data: timeSeriesData.values,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.3,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.parsed.y;
                                    if (metric === 'cost') {
                                        label = '¬£' + label.toFixed(2);
                                    } else if (metric === 'co2' || metric === 'weight') {
                                        label = label.toFixed(2) + ' kg';
                                    } else if (metric === 'distance') {
                                        label = label.toFixed(2) + ' km';
                                    } else if (metric === 'efficiency') {
                                        label = '¬£' + label.toFixed(3) + '/km';
                                    } else {
                                        label = label.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (metric === 'cost') {
                                        return '¬£' + value.toFixed(0);
                                    } else if (metric === 'co2' || metric === 'weight') {
                                        return value.toFixed(0) + ' kg';
                                    } else if (metric === 'distance') {
                                        return value.toFixed(0) + ' km';
                                    } else if (metric === 'efficiency') {
                                        return '¬£' + value.toFixed(2);
                                    }
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Generate time series data
        function generateTimeSeriesData(metric) {
            const monthlyData = {};
            const dataToUse = filteredData;
            dataToUse.forEach(s => {
                const date = new Date(s['Shipping Date']);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        count: 0,
                        cost: 0,
                        co2: 0,
                        weight: 0,
                        distance: 0,
                        efficiency: []
                    };
                }
                
                monthlyData[monthKey].count++;
                monthlyData[monthKey].cost += s.cost;
                monthlyData[monthKey].co2 += s.co2;
                monthlyData[monthKey].weight += s.weight;
                monthlyData[monthKey].distance += s.distance;
                monthlyData[monthKey].efficiency.push(s.efficiency);
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            let values = [];
            
            switch(metric) {
                case 'count':
                    values = sortedMonths.map(m => monthlyData[m].count);
                    break;
                case 'co2':
                    values = sortedMonths.map(m => monthlyData[m].co2);
                    break;
                case 'cost':
                    values = sortedMonths.map(m => monthlyData[m].cost);
                    break;
                case 'distance':
                    values = sortedMonths.map(m => monthlyData[m].distance);
                    break;
                case 'efficiency':
                    values = sortedMonths.map(m => {
                        const effArray = monthlyData[m].efficiency;
                        return effArray.length > 0 ? effArray.reduce((a, b) => a + b) / effArray.length : 0;
                    });
                    break;
                case 'co2perkg':
                    values = sortedMonths.map(m => 
                        monthlyData[m].weight > 0 ? monthlyData[m].co2 / monthlyData[m].weight : 0
                    );
                    break;
            }
            
            return {
                labels: sortedMonths,
                values: values
            };
        }

        // Close time series modal
        function closeTimeSeriesModal() {
            document.getElementById('timeSeriesModal').style.display = 'none';
            if (timeSeriesChart) {
                timeSeriesChart.destroy();
                timeSeriesChart = null;
            }
        }

        // Initialize filters
        function initializeFilters() {
            // Add event listeners
            document.getElementById('globalSearch').addEventListener('input', applyFilters);
            document.getElementById('searchCountry').addEventListener('change', function() {
                const country = this.value;
                document.getElementById('locationCodeSearch').disabled = !country;
                if (!country) {
                    document.getElementById('searchCountry').value = '';
                    document.getElementById('locationCodeSearch').value = '';
                    document.getElementById('locationCodeSearch').disabled = true;
                }
                applyFilters();
            });
            document.getElementById('locationCodeSearch').addEventListener('input', function() {
                const searchTerm = this.value.toUpperCase();
                const country = document.getElementById('searchCountry').value;
                
                // Show real-time hints for UK postal codes
                if ((country === 'United Kingdom' || country === 'UK') && searchTerm.length > 0) {
                    const mapping = POSTAL_CODE_MAPPINGS[country] || POSTAL_CODE_MAPPINGS['United Kingdom'];
                    if (mapping && mapping[searchTerm]) {
                        const info = mapping[searchTerm];
                        document.getElementById('hintText').textContent = `${searchTerm} = ${info.name} (${info.region})`;
                        document.getElementById('hintText').style.color = '#27ae60';
                    } else {
                        // Find partial matches
                        const matches = Object.entries(mapping || {})
                            .filter(([code, info]) => code.startsWith(searchTerm))
                            .slice(0, 5);
                        
                        if (matches.length > 0) {
                            const suggestions = matches.map(([code, info]) => `${code}=${info.name}`).join(', ');
                            document.getElementById('hintText').textContent = `Suggestions: ${suggestions}`;
                            document.getElementById('hintText').style.color = '#95a5a6';
                        } else {
                            document.getElementById('hintText').textContent = 'No matching postal codes found';
                            document.getElementById('hintText').style.color = '#e74c3c';
                        }
                    }
                }
                
                handleLocationCodeSearch();
            });
            document.getElementById('originCountryFilter').addEventListener('change', applyFilters);
            document.getElementById('destCountryFilter').addEventListener('change', applyFilters);
            document.getElementById('transportModeFilter').addEventListener('change', applyFilters);
            document.getElementById('shipperFilter').addEventListener('change', applyFilters);
            document.getElementById('startDate').addEventListener('change', applyFilters);
            document.getElementById('endDate').addEventListener('change', applyFilters);
            document.getElementById('minWeight').addEventListener('input', applyFilters);
            document.getElementById('maxWeight').addEventListener('input', applyFilters);
            document.getElementById('minCost').addEventListener('input', applyFilters);
            document.getElementById('maxCost').addEventListener('input', applyFilters);
            document.getElementById('tableSearch').addEventListener('input', filterTable);
            document.getElementById('toggleRoutes').addEventListener('change', toggleRoutes);
            document.getElementById('toggleClusters').addEventListener('change', toggleClustering);
        }

        // Handle location code search with country context
        function handleLocationCodeSearch() {
            const country = document.getElementById('searchCountry').value;
            const searchTerm = document.getElementById('locationCodeSearch').value.trim().toUpperCase();
            
            if (!country || searchTerm.length < 1) {
                applyFilters();
                return;
            }
            
            // Check if we have postal code mappings for this country
            const countryMappings = POSTAL_CODE_MAPPINGS[country] || POSTAL_CODE_MAPPINGS[country.toUpperCase()];
            let enhancedSearch = searchTerm;
            let postalCodeInfo = null;
            
            if (countryMappings && countryMappings[searchTerm]) {
                // We have a postal code mapping!
                postalCodeInfo = countryMappings[searchTerm];
                enhancedSearch = postalCodeInfo.name;
                
                // Show info message about the postal code
                showSuccess(`Postal code ${searchTerm} corresponds to ${postalCodeInfo.name} (${postalCodeInfo.region})`);
                setTimeout(clearMessages, 5000);
            }
            
            // Filter data based on area code or mapped location name
            const tempFiltered = shipmentData.filter(shipment => {
                // Check if shipment matches the country
                const matchesOriginCountry = shipment['Origin Country'] === country;
                const matchesDestCountry = shipment['Destination Country'] === country;
                
                if (!matchesOriginCountry && !matchesDestCountry) return false;
                
                // Check if location matches the search term or mapped location
                const collectionArea = (shipment['Collection Area Name'] || '').toUpperCase();
                const deliveryArea = (shipment['Delivery Area Name'] || '').toUpperCase();
                
                // Direct code match
                const matchesOriginCode = matchesOriginCountry && collectionArea.includes(searchTerm);
                const matchesDestCode = matchesDestCountry && deliveryArea.includes(searchTerm);
                
                // Mapped location name match (if we found a postal code mapping)
                let matchesOriginName = false;
                let matchesDestName = false;
                
                if (postalCodeInfo) {
                    const searchName = postalCodeInfo.name.toUpperCase();
                    matchesOriginName = matchesOriginCountry && collectionArea.includes(searchName);
                    matchesDestName = matchesDestCountry && deliveryArea.includes(searchName);
                }
                
                return matchesOriginCode || matchesDestCode || matchesOriginName || matchesDestName;
            });
            
            if (tempFiltered.length > 0) {
                // Apply other filters on top of area code search
                filteredData = tempFiltered.filter(shipment => {
                    return applyOtherFilters(shipment);
                });
                
                updateDisplay();
                
                // Zoom to the filtered area
                if (map && filteredData.length > 0) {
                    const bounds = L.latLngBounds();
                    filteredData.forEach(s => {
                        bounds.extend(s.fromCoords);
                        bounds.extend(s.toCoords);
                    });
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            } else {
                const notFoundMsg = postalCodeInfo 
                    ? `No shipments found for postal code "${searchTerm}" (${postalCodeInfo.name}) in ${country}`
                    : `No shipments found with area code "${searchTerm}" in ${country}`;
                showError(notFoundMsg);
                setTimeout(clearMessages, 3000);
            }
        }
        
        // Apply other filters (helper function)
        function applyOtherFilters(shipment) {
            const globalSearch = document.getElementById('globalSearch').value.toLowerCase();
            const originCountry = document.getElementById('originCountryFilter').value;
            const destCountry = document.getElementById('destCountryFilter').value;
            const transportMode = document.getElementById('transportModeFilter').value;
            const shipper = document.getElementById('shipperFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const minWeight = parseFloat(document.getElementById('minWeight').value) || 0;
            const maxWeight = parseFloat(document.getElementById('maxWeight').value) || Infinity;
            const minCost = parseFloat(document.getElementById('minCost').value) || 0;
            const maxCost = parseFloat(document.getElementById('maxCost').value) || Infinity;
            
            // Global search
            if (globalSearch && !(
                (shipment['Unique identifier'] || '').toLowerCase().includes(globalSearch) ||
                (shipment['Collection Area Name'] || '').toLowerCase().includes(globalSearch) ||
                (shipment['Delivery Area Name'] || '').toLowerCase().includes(globalSearch) ||
                (shipment['Shipper'] || '').toLowerCase().includes(globalSearch) ||
                (shipment['Transport Mode'] || '').toLowerCase().includes(globalSearch)
            )) return false;
            
            // Country filters
            if (originCountry && shipment['Origin Country'] !== originCountry) return false;
            if (destCountry && shipment['Destination Country'] !== destCountry) return false;
            
            // Transport mode filter
            if (transportMode && shipment['Transport Mode'] !== transportMode) return false;
            
            // Shipper filter
            if (shipper && shipment['Shipper'] !== shipper) return false;
            
            // Date range filter
            if (startDate || endDate) {
                const shipmentDate = new Date(shipment['Shipping Date']);
                if (startDate && shipmentDate < new Date(startDate)) return false;
                if (endDate && shipmentDate > new Date(endDate)) return false;
            }
            
            // Weight filter
            if (shipment.weight < minWeight || shipment.weight > maxWeight) return false;
            
            // Cost filter
            if (shipment.cost < minCost || shipment.cost > maxCost) return false;
            
            return true;
        }

        // Apply all filters
        function applyFilters() {
            const globalSearch = document.getElementById('globalSearch').value.toLowerCase();
            const searchCountry = document.getElementById('searchCountry').value;
            const locationCode = document.getElementById('locationCodeSearch').value.toUpperCase();
            
            filteredData = shipmentData.filter(shipment => {
                // Location code search with country
                if (searchCountry && locationCode) {
                    const matchesOrigin = shipment['Origin Country'] === searchCountry && 
                        (shipment['Collection Area Name'] || '').toUpperCase().includes(locationCode);
                    const matchesDest = shipment['Destination Country'] === searchCountry && 
                        (shipment['Delivery Area Name'] || '').toUpperCase().includes(locationCode);
                    
                    if (!matchesOrigin && !matchesDest) return false;
                }
                
                // Apply other filters
                return applyOtherFilters(shipment) && (
                    !globalSearch || (
                        (shipment['Unique identifier'] || '').toLowerCase().includes(globalSearch) ||
                        (shipment['Collection Area Name'] || '').toLowerCase().includes(globalSearch) ||
                        (shipment['Delivery Area Name'] || '').toLowerCase().includes(globalSearch) ||
                        (shipment['Shipper'] || '').toLowerCase().includes(globalSearch) ||
                        (shipment['Transport Mode'] || '').toLowerCase().includes(globalSearch)
                    )
                );
            });
            
            updateDisplay();
            updateActiveFilters();
        }

        // Update active filters display
        function updateActiveFilters() {
            const container = document.getElementById('activeFilters');
            const filters = [];
            
            if (document.getElementById('globalSearch').value) {
                filters.push({ type: 'Search', value: document.getElementById('globalSearch').value });
            }
            if (document.getElementById('searchCountry').value && document.getElementById('locationCodeSearch').value) {
                filters.push({ type: 'Area Code', value: `${document.getElementById('locationCodeSearch').value} in ${document.getElementById('searchCountry').value}` });
            }
            if (document.getElementById('originCountryFilter').value) {
                filters.push({ type: 'Origin', value: document.getElementById('originCountryFilter').value });
            }
            if (document.getElementById('destCountryFilter').value) {
                filters.push({ type: 'Destination', value: document.getElementById('destCountryFilter').value });
            }
            if (document.getElementById('transportModeFilter').value) {
                filters.push({ type: 'Mode', value: document.getElementById('transportModeFilter').value });
            }
            if (document.getElementById('shipperFilter').value) {
                filters.push({ type: 'Shipper', value: document.getElementById('shipperFilter').value });
            }
            
            container.innerHTML = filters.map(f => 
                `<div class="filter-tag">${f.type}: ${f.value} <span class="remove" onclick="removeFilter('${f.type}')">√ó</span></div>`
            ).join('');
        }

        // Remove specific filter
        function removeFilter(type) {
            switch(type) {
                case 'Search': document.getElementById('globalSearch').value = ''; break;
                case 'Area Code': 
                    document.getElementById('searchCountry').value = ''; 
                    document.getElementById('locationCodeSearch').value = ''; 
                    document.getElementById('locationCodeSearch').disabled = true;
                    break;
                case 'Origin': document.getElementById('originCountryFilter').value = ''; break;
                case 'Destination': document.getElementById('destCountryFilter').value = ''; break;
                case 'Mode': document.getElementById('transportModeFilter').value = ''; break;
                case 'Shipper': document.getElementById('shipperFilter').value = ''; break;
            }
            applyFilters();
        }

        // Reset all filters
        function resetFilters() {
            document.getElementById('globalSearch').value = '';
            document.getElementById('locationCodeSearch').value = '';
            document.getElementById('originCountryFilter').value = '';
            document.getElementById('destCountryFilter').value = '';
            document.getElementById('transportModeFilter').value = '';
            document.getElementById('shipperFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('minWeight').value = '';
            document.getElementById('maxWeight').value = '';
            document.getElementById('minCost').value = '';
            document.getElementById('maxCost').value = '';
            
            filteredData = [...shipmentData];
            updateDisplay();
            updateActiveFilters();
        }

        // Filter table
        function filterTable() {
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            const rows = document.getElementById('tableBody').getElementsByTagName('tr');
            
            Array.from(rows).forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Sort table
        function sortTable(column) {
            const headers = document.querySelectorAll('#dataTable th');
            headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
            
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            headers[column].classList.add(`sorted-${sortDirection}`);
            
            filteredData.sort((a, b) => {
                let aVal, bVal;
                
                switch(column) {
                    case 0: aVal = a['Unique identifier']; bVal = b['Unique identifier']; break;
                    case 1: aVal = new Date(a['Shipping Date']); bVal = new Date(b['Shipping Date']); break;
                    case 2: aVal = a['Collection Area Name']; bVal = b['Collection Area Name']; break;
                    case 3: aVal = a['Delivery Area Name']; bVal = b['Delivery Area Name']; break;
                    case 4: aVal = a['Transport Mode']; bVal = b['Transport Mode']; break;
                    case 5: aVal = a['Shipper']; bVal = b['Shipper']; break;
                    case 6: aVal = a.weight; bVal = b.weight; break;
                    case 7: aVal = a.cost; bVal = b.cost; break;
                    case 8: aVal = a.co2; bVal = b.co2; break;
                    case 9: aVal = a.distance; bVal = b.distance; break;
                    case 10: aVal = a.efficiency; bVal = b.efficiency; break;
                }
                
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            updateTable(filteredData);
        }

        // Toggle routes visibility
        function toggleRoutes() {
            const show = document.getElementById('toggleRoutes').checked;
            polylines.forEach(p => {
                if (show) {
                    p.addTo(map);
                } else {
                    map.removeLayer(p);
                }
            });
        }

        // Toggle marker clustering
        function toggleClustering() {
            const useClusters = document.getElementById('toggleClusters').checked;
            
            if (useClusters) {
                // Add markers to cluster group
                markers.forEach(m => {
                    map.removeLayer(m);
                    markerClusterGroup.addLayer(m);
                });
                map.addLayer(markerClusterGroup);
            } else {
                // Remove cluster group and add markers directly
                map.removeLayer(markerClusterGroup);
                markerClusterGroup.clearLayers();
                markers.forEach(m => m.addTo(map));
            }
        }

        // Calculate distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Delay function
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Geocode location using Nominatim
        async function geocodeLocation(location, country) {
            const cacheKey = `${location}, ${country}`.toLowerCase();
            
            if (geocodeCache[cacheKey]) {
                return geocodeCache[cacheKey];
            }

            try {
                let query = location ? `${location}, ${country}` : country;
                let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                
                let response = await fetch(url, {
                    headers: {
                        'User-Agent': 'ShipmentOperationsMap/1.0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Geocoding API error');
                }
                
                let data = await response.json();
                
                if (data.length === 0 && location) {
                    await delay(1000);
                    url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(country)}&limit=1`;
                    response = await fetch(url, {
                        headers: {
                            'User-Agent': 'ShipmentOperationsMap/1.0'
                        }
                    });
                    data = await response.json();
                }
                
                if (data.length > 0) {
                    const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                    geocodeCache[cacheKey] = coords;
                    return coords;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }

            const fallbackCoords = getFallbackCoordinates(country);
            geocodeCache[cacheKey] = fallbackCoords;
            return fallbackCoords;
        }

        // Fallback coordinates
        function getFallbackCoordinates(country) {
            const countryCoords = {
                'united states': [39.8283, -98.5795],
                'usa': [39.8283, -98.5795],
                'united kingdom': [55.3781, -3.4360],
                'uk': [55.3781, -3.4360],
                'china': [35.8617, 104.1954],
                'japan': [36.2048, 138.2529],
                'germany': [51.1657, 10.4515],
                'france': [46.2276, 2.2137],
                'italy': [41.8719, 12.5674],
                'spain': [40.4637, -3.7492],
                'canada': [56.1304, -106.3468],
                'australia': [-25.2744, 133.7751],
                'brazil': [-14.2350, -51.9253],
                'india': [20.5937, 78.9629],
                'mexico': [23.6345, -102.5528]
            };
            
            const coords = countryCoords[country.toLowerCase()];
            if (coords) {
                return [coords[0] + (Math.random() - 0.5) * 2, coords[1] + (Math.random() - 0.5) * 2];
            }
            
            return [0 + (Math.random() - 0.5) * 10, 0 + (Math.random() - 0.5) * 10];
        }

        // Show error
        function showError(message) {
            document.getElementById('errorContainer').innerHTML = `
                <div class="error-message">
                    <span>‚ö†Ô∏è</span> ${message}
                </div>
            `;
        }

        // Show success
        function showSuccess(message) {
            document.getElementById('successContainer').innerHTML = `
                <div class="success-message">
                    <span>‚úÖ</span> ${message}
                </div>
            `;
            setTimeout(() => {
                document.getElementById('successContainer').innerHTML = '';
            }, 5000);
        }

        // Clear messages
        function clearMessages() {
            document.getElementById('errorContainer').innerHTML = '';
            document.getElementById('successContainer').innerHTML = '';
        }

        // Show random CO2 fact
        function showRandomCO2Fact() {
            const randomFact = co2Facts[Math.floor(Math.random() * co2Facts.length)];
            document.getElementById('co2Fact').textContent = randomFact;
        }

        // File input handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `Selected: ${file.name}`;
                document.getElementById('processBtn').disabled = false;
                clearMessages();
            }
        });

        // Process button handler
        document.getElementById('processBtn').addEventListener('click', function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Please select a file first!');
                return;
            }

            clearMessages();
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('results').style.display = 'none';
            
            // Start showing CO2 facts
            showRandomCO2Fact();
            const factInterval = setInterval(showRandomCO2Fact, 4000);
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        raw: false,
                        defval: ''
                    });
                    
                    if (jsonData.length === 0) {
                        throw new Error('No data found in the Excel file');
                    }
                    
                    const normalizedData = jsonData.map(row => {
                        const normalizedRow = {};
                        Object.entries(row).forEach(([key, value]) => {
                            const normalizedKey = key
                                .replace(/\u00A0/g, ' ')
                                .replace(/\s+/g, ' ')
                                .trim();
                            normalizedRow[normalizedKey] = value;
                        });
                        return normalizedRow;
                    });
                    
                    const actualColumns = Object.keys(normalizedData[0]);
                    const missingColumns = [];
                    
                    REQUIRED_COLUMNS.forEach(reqCol => {
                        const columnNames = Array.isArray(reqCol) ? reqCol : [reqCol];
                        
                        const found = columnNames.some(colName => {
                            return actualColumns.some(actCol => {
                                return actCol.toLowerCase() === colName.toLowerCase() || 
                                       actCol === colName;
                            });
                        });
                        
                        if (!found) {
                            missingColumns.push(columnNames[0]);
                        }
                    });
                    
                    if (missingColumns.length > 0) {
                        let errorMsg = `Missing required columns: ${missingColumns.join(', ')}\n\n`;
                        errorMsg += `Columns found in your file:\n${actualColumns.map(col => `‚Ä¢ "${col}"`).join('\n')}`;
                        
                        throw new Error(errorMsg);
                    }
                    
                    processShipmentData(normalizedData).then(() => {
                        clearInterval(factInterval);
                    });
                    
                } catch (error) {
                    clearInterval(factInterval);
                    document.getElementById('loader').style.display = 'none';
                    showError(error.message);
                    console.error('Error processing file:', error);
                }
            };
            
            reader.onerror = function() {
                clearInterval(factInterval);
                document.getElementById('loader').style.display = 'none';
                showError('Failed to read the file. Please ensure it is a valid Excel file.');
            };
            
            reader.readAsArrayBuffer(file);
        });

        // Process shipment data
        async function processShipmentData(data) {
            document.getElementById('loaderText').textContent = 'Processing shipment data and geocoding locations...';
            
            const uniqueLocations = new Set();
            
            data.forEach(row => {
                const collectionKey = `${row['Collection Area Name'] || ''},${row['Origin Country'] || ''}`;
                const deliveryKey = `${row['Delivery Area Name'] || ''},${row['Destination Country'] || ''}`;
                uniqueLocations.add(collectionKey);
                uniqueLocations.add(deliveryKey);
            });
            
            const locationsArray = Array.from(uniqueLocations);
            let geocodedCount = 0;
            
            for (const locationKey of locationsArray) {
                const [area, country] = locationKey.split(',');
                await geocodeLocation(area, country);
                
                geocodedCount++;
                const progress = (geocodedCount / locationsArray.length) * 100;
                document.getElementById('loaderText').textContent = 
                    `Geocoding locations... (${geocodedCount}/${locationsArray.length})`;
                
                await delay(1000);
            }
            
            shipmentData = await Promise.all(data.map(async (row) => {
                const getColumnValue = (row, columnNames) => {
                    for (const name of columnNames) {
                        if (row[name] !== undefined) return row[name];
                    }
                    return '';
                };
                
                const collectionArea = getColumnValue(row, ['Collection Area Name', 'collection area name']);
                const deliveryArea = getColumnValue(row, ['Delivery Area Name', 'delivery area name']);
                const originCountry = getColumnValue(row, ['Origin Country', 'origin country']);
                const destinationCountry = getColumnValue(row, ['Destination Country', 'destination country']);
                
                const fromCoords = await geocodeLocation(collectionArea, originCountry);
                const toCoords = await geocodeLocation(deliveryArea, destinationCountry);
                const distance = calculateDistance(fromCoords[0], fromCoords[1], toCoords[0], toCoords[1]);
                
                const weight = parseFloat(row['Weight'] || row['weight'] || 0) || 0;
                const emissionFactor = parseFloat(row['Emission factor of emission type'] || row['emission factor of emission type'] || 0) || 0;
                const cost = parseFloat(row['Cost of shipment'] || row['cost of shipment'] || 0) || 0;
                
                const co2 = weight * emissionFactor * (distance / 1000);
                const efficiency = distance > 0 ? (cost / distance) : 0;
                
                return {
                    'Unique identifier': getColumnValue(row, ['Unique identifier', 'Unique identifier', 'unique identifier']),
                    'Shipping Date': getColumnValue(row, ['Collection Date', 'Shipping Date', 'shipping date']),
                    'Collection Area Name': collectionArea,
                    'Delivery Area Name': deliveryArea,
                    'Origin Country': originCountry,
                    'Destination Country': destinationCountry,
                    'Transport Mode': getColumnValue(row, ['Transport Mode', 'transport mode']),
                    'Shipper': getColumnValue(row, ['Shipper', 'shipper']),
                    'Emission type by shipper mode': getColumnValue(row, ['Emission type by shipper mode', 'emission type by shipper mode']),
                    'Emission factor of emission type': emissionFactor,
                    'Weight': weight,
                    'Cost of shipment': cost,
                    fromCoords,
                    toCoords,
                    distance,
                    weight,    
                    cost,
                    co2,
                    efficiency
                };
            }));
            
            filteredData = [...shipmentData];
            document.getElementById('loader').style.display = 'none';
            populateFilterOptions();
            displayResults();
            showSuccess(`Successfully processed ${shipmentData.length} shipments!`);
        }

        // Populate filter options
        function populateFilterOptions() {
            const originCountries = [...new Set(shipmentData.map(s => s['Origin Country']))].sort();
            const destCountries = [...new Set(shipmentData.map(s => s['Destination Country']))].sort();
            const transportModes = [...new Set(shipmentData.map(s => s['Transport Mode']))].sort();
            const shippers = [...new Set(shipmentData.map(s => s['Shipper']))].sort();
            const allCountries = [...new Set([...originCountries, ...destCountries])].sort();
            
            populateSelect('originCountryFilter', originCountries);
            populateSelect('destCountryFilter', destCountries);
            populateSelect('transportModeFilter', transportModes);
            populateSelect('shipperFilter', shippers);
            populateSelect('searchCountry', allCountries);
        }

        // Populate select element
        function populateSelect(elementId, options) {
            const select = document.getElementById(elementId);
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">All</option>';
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            select.value = currentValue;
        }

        // Display results
        function displayResults() {
            document.getElementById('results').style.display = 'block';
            updateStatistics();
            initializeMap();
            updateMap();
            updateCharts();
            updateTable(filteredData);
            updateRecordCount();
            populateRouteSelectors(); // Add this line
}       

        // Update display
        function updateDisplay() {
            updateStatistics();
            updateMap();
            updateCharts();
            updateTable(filteredData);
            updateRecordCount();
        }

        // Update statistics
        function updateStatistics() {
            const dataToUse = filteredData;
            
            
            const totalShipments = dataToUse.length;
            const totalCO2 = dataToUse.reduce((sum, s) => sum + s.co2, 0);
            const totalCost = dataToUse.reduce((sum, s) => sum + s.cost, 0);
            const totalWeight = dataToUse.reduce((sum, s) => sum + s.weight, 0);
            const totalDistance = dataToUse.reduce((sum, s) => sum + s.distance, 0);
            const avgCostPerKm = totalDistance > 0 ? (totalCost / totalDistance) : 0;
            
            // Get available years
            const years = [...new Set(filteredData.map(s => 
                new Date(s['Shipping Date']).getFullYear()
            ))].sort();
            
            const yearOptions = ['all', ...years].map(year => 
                `<option value="${year}" ${year === currentStatYear ? 'selected' : ''}>${year === 'all' ? 'All Years' : year}</option>`
            ).join('');
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card primary" onclick="showTimeSeriesModal('count', 'Total Shipments Over Time')">
                    <h3>Total Shipments</h3>
                    <div class="value">${totalShipments.toLocaleString()}</div>
                  
                </div>
                <div class="stat-card success" onclick="showTimeSeriesModal('co2', 'CO2 Emissions Over Time')">
                    <h3>Total CO2 Emissions</h3>
                    <div class="value">${totalCO2.toFixed(0)} kg</div>
                </div>
                <div class="stat-card warning" onclick="showTimeSeriesModal('cost', 'Total Cost Over Time')">
                    <h3>Total Cost</h3>
                    <div class="value">¬£${(totalCost / 1000).toFixed(1)}k</div>
                </div>
                <div class="stat-card danger" onclick="showTimeSeriesModal('distance', 'Total Distance Over Time')">
                    <h3>Total Distance</h3>
                    <div class="value">${(totalDistance / 1000).toFixed(0)}k km</div>
                </div>
                <div class="stat-card info" onclick="showTimeSeriesModal('efficiency', 'Cost per Kilometer Over Time')">
                    <h3>Cost per Kilometer</h3>
                    <div class="value">¬£${avgCostPerKm.toFixed(2)}/km</div>
                </div>
                <div class="stat-card primary" onclick="showTimeSeriesModal('co2perkg', 'CO2 per Kg Shipped Over Time')">
                    <h3>CO2 per Kg Shipped</h3>
                    <div class="value">${totalWeight > 0 ? (totalCO2 / totalWeight).toFixed(3) : '0'} kg</div>
                </div>
            `;
        }

        // Initialize map
        function initializeMap() {
            if (!map) {
                map = L.map('map').setView([20, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                // Initialize marker cluster group
                markerClusterGroup = L.markerClusterGroup({
                    showCoverageOnHover: false,
                    maxClusterRadius: 50
                });
            }
        }

        // Update map
        function updateMap() {
            // Clear existing markers and polylines
            if (markerClusterGroup) {
                markerClusterGroup.clearLayers();
            }
            markers.forEach(m => map.removeLayer(m));
            polylines.forEach(p => map.removeLayer(p));
            markers = [];
            polylines = [];
            
            const locationMarkers = {};
            const locationStats = {};
            
            // Calculate location statistics
            filteredData.forEach(shipment => {
                const fromKey = `${shipment['Collection Area Name']}_${shipment['Origin Country']}`;
                const toKey = `${shipment['Delivery Area Name']}_${shipment['Destination Country']}`;
                
                if (!locationStats[fromKey]) {
                    locationStats[fromKey] = {
                        name: shipment['Collection Area Name'],
                        country: shipment['Origin Country'],
                        coords: shipment.fromCoords,
                        outbound: 0,
                        inbound: 0,
                        totalWeight: 0,
                        totalCost: 0,
                        totalCO2: 0
                    };
                }
                
                if (!locationStats[toKey]) {
                    locationStats[toKey] = {
                        name: shipment['Delivery Area Name'],
                        country: shipment['Destination Country'],
                        coords: shipment.toCoords,
                        outbound: 0,
                        inbound: 0,
                        totalWeight: 0,
                        totalCost: 0,
                        totalCO2: 0
                    };
                }
                
                locationStats[fromKey].outbound++;
                locationStats[fromKey].totalWeight += shipment.weight;
                locationStats[fromKey].totalCost += shipment.cost;
                locationStats[fromKey].totalCO2 += shipment.co2;
                
                locationStats[toKey].inbound++;
                locationStats[toKey].totalWeight += shipment.weight;
                locationStats[toKey].totalCost += shipment.cost;
                locationStats[toKey].totalCO2 += shipment.co2;
            });
            
            // Create markers with enhanced popups
            Object.entries(locationStats).forEach(([key, stats]) => {
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${stats.outbound > stats.inbound ? '#e74c3c' : '#27ae60'}; 
                           color: white; width: 30px; height: 30px; border-radius: 50%; 
                           display: flex; align-items: center; justify-content: center; 
                           font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                           ${stats.outbound + stats.inbound}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                const marker = L.marker(stats.coords, { icon })
                    .bindPopup(`<div class="popup-content">
                        <h4>${stats.name}</h4>
                        <div class="info-grid">
                            <span class="label">Country:</span>
                            <span class="value">${stats.country}</span>
                            
                            <span class="label">Outbound Shipments:</span>
                            <span class="value">${stats.outbound}</span>
                            
                            <span class="label">Inbound Shipments:</span>
                            <span class="value">${stats.inbound}</span>
                            
                            <span class="label">Total Volume:</span>
                            <span class="value">${stats.totalWeight.toFixed(2)} kg</span>
                            
                            <span class="label">Total Value:</span>
                            <span class="value">¬£${stats.totalCost.toFixed(2)}</span>
                            
                            <span class="label">Total CO2:</span>
                            <span class="value">${stats.totalCO2.toFixed(2)} kg</span>
                            
                            <span class="label">Avg Cost/Shipment:</span>
                            <span class="value">¬£${(stats.totalCost / (stats.outbound + stats.inbound)).toFixed(2)}</span>
                        </div>
                    </div>`);
                
                markers.push(marker);
                locationMarkers[key] = marker;
                
                if (document.getElementById('toggleClusters').checked) {
                    markerClusterGroup.addLayer(marker);
                } else {
                    marker.addTo(map);
                }
            });
            
            if (document.getElementById('toggleClusters').checked) {
                map.addLayer(markerClusterGroup);
            }
            
            // Add route polylines with enhanced styling
            const routeStats = {};
            
            filteredData.forEach(shipment => {
                const routeKey = `${shipment.fromCoords.join(',')}_${shipment.toCoords.join(',')}`;
                
                if (!routeStats[routeKey]) {
                    routeStats[routeKey] = {
                        coords: [shipment.fromCoords, shipment.toCoords],
                        shipments: [],
                        totalWeight: 0,
                        totalCost: 0,
                        totalCO2: 0,
                        modes: new Set()
                    };
                }
                
                routeStats[routeKey].shipments.push(shipment);
                routeStats[routeKey].totalWeight += shipment.weight;
                routeStats[routeKey].totalCost += shipment.cost;
                routeStats[routeKey].totalCO2 += shipment.co2;
                routeStats[routeKey].modes.add(shipment['Transport Mode']);
            });
            
            Object.values(routeStats).forEach(route => {
                const weight = Math.min(Math.max(route.shipments.length / 2, 2), 10);
                const primaryMode = Array.from(route.modes)[0].toLowerCase();
                let polylineColor = transportColors.other;
                
                for (const [mode, color] of Object.entries(transportColors)) {
                    if (primaryMode.includes(mode)) {
                        polylineColor = color;
                        break;
                    }
                }
                
                const polyline = L.polyline(route.coords, {
                    color: polylineColor,
                    weight: weight,
                    opacity: 0.6
                }).bindPopup(`<div class="popup-content">
                    <h4>Route Summary</h4>
                    <div class="info-grid">
                        <span class="label">Total Shipments:</span>
                        <span class="value">${route.shipments.length}</span>
                        
                        <span class="label">Transport Modes:</span>
                        <span class="value">${Array.from(route.modes).join(', ')}</span>
                        
                        <span class="label">Total Weight:</span>
                        <span class="value">${route.totalWeight.toFixed(2)} kg</span>
                        
                        <span class="label">Total Cost:</span>
                        <span class="value">¬£${route.totalCost.toFixed(2)}</span>
                        
                        <span class="label">Total CO2:</span>
                        <span class="value">${route.totalCO2.toFixed(2)} kg</span>
                        
                        <span class="label">Avg Distance:</span>
                        <span class="value">${(route.shipments.reduce((sum, s) => sum + s.distance, 0) / route.shipments.length).toFixed(2)} km</span>
                    </div>
                </div>`);
                
                polylines.push(polyline);
                
                if (document.getElementById('toggleRoutes').checked) {
                    polyline.addTo(map);
                }
            });
            
            // Fit map to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Get color for transport mode
        function getTransportModeColor(mode) {
            const modeLower = mode.toLowerCase();
            for (const [key, color] of Object.entries(transportColors)) {
                if (modeLower.includes(key)) {
                    return color;
                }
            }
            return transportColors.other;
        }

        // Update charts
        function updateCharts() {
            // Transport mode chart
            const transportData = {};
            filteredData.forEach(s => {
                const mode = s['Transport Mode'] || 'Unknown';
                if (!transportData[mode]) {
                    transportData[mode] = { count: 0, cost: 0, co2: 0 };
                }
                transportData[mode].count++;
                transportData[mode].cost += s.cost;
                transportData[mode].co2 += s.co2;
            });
            
            const ctx1 = document.getElementById('transportChart').getContext('2d');
            if (charts.transport) charts.transport.destroy();
            
            const transportLabels = Object.keys(transportData);
            const transportBackgroundColors = transportLabels.map(mode => getTransportModeColor(mode));
            
            charts.transport = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: transportLabels,
                    datasets: [{
                        data: Object.values(transportData).map(d => d.count),
                        backgroundColor: transportBackgroundColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const mode = context.label;
                                    const data = transportData[mode];
                                    return [
                                        `${mode}: ${data.count} shipments`,
                                        `Cost: ¬£${data.cost.toFixed(2)}`,
                                        `CO2: ${data.co2.toFixed(2)} kg`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
            
            // Top routes chart
            const routeCounts = {};
            filteredData.forEach(s => {
                const route = `${s['Origin Country']} ‚Üí ${s['Destination Country']}`;
                routeCounts[route] = (routeCounts[route] || 0) + 1;
            });
            
            const topRoutes = Object.entries(routeCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const ctx2 = document.getElementById('routesChart').getContext('2d');
            if (charts.routes) charts.routes.destroy();
            charts.routes = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: topRoutes.map(r => r[0]),
                    datasets: [{
                        label: 'Number of Shipments',
                        data: topRoutes.map(r => r[1]),
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Monthly trends chart
            const monthlyData = {};
            filteredData.forEach(s => {
                const date = new Date(s['Shipping Date']);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { count: 0, cost: 0, co2: 0 };
                }
                monthlyData[monthKey].count++;
                monthlyData[monthKey].cost += s.cost;
                monthlyData[monthKey].co2 += s.co2;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            
            const ctx3 = document.getElementById('trendsChart').getContext('2d');
            if (charts.trends) charts.trends.destroy();
            charts.trends = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Shipments',
                        data: sortedMonths.map(m => monthlyData[m].count),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        yAxisID: 'y',
                        tension: 0.3
                    }, {
                        label: 'CO2 Emissions (kg)',
                        data: sortedMonths.map(m => monthlyData[m].co2),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                    }
                }
            });
            
            // Scatter plot - Cost vs CO2 with transport mode colors
            const scatterDataByMode = {};
            filteredData.forEach(s => {
                const mode = s['Transport Mode'] || 'Unknown';
                if (!scatterDataByMode[mode]) {
                    scatterDataByMode[mode] = [];
                }
                scatterDataByMode[mode].push({
                    x: s.cost,
                    y: s.co2
                });
            });
            
            const scatterDatasets = Object.entries(scatterDataByMode).map(([mode, data]) => ({
                label: mode,
                data: data,
                backgroundColor: getTransportModeColor(mode) + '99', // Add transparency
                borderColor: getTransportModeColor(mode),
                borderWidth: 1,
                pointRadius: 3,
                pointHoverRadius: 5
            }));
            
            const ctx4 = document.getElementById('scatterChart').getContext('2d');
            if (charts.scatter) charts.scatter.destroy();
            charts.scatter = new Chart(ctx4, {
                type: 'scatter',
                data: {
                    datasets: scatterDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Cost (¬£)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'CO2 Emissions (kg)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return [
                                        `Mode: ${context.dataset.label}`,
                                        `Cost: ¬£${context.parsed.x.toFixed(2)}`,
                                        `CO2: ${context.parsed.y.toFixed(2)} kg`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update table
        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = data.map(s => `
                <tr>
                    <td>${s['Unique identifier'] || ''}</td>
                    <td>${s['Shipping Date'] || ''}</td>
                    <td>${s['Collection Area Name'] || ''}, ${s['Origin Country'] || ''}</td>
                    <td>${s['Delivery Area Name'] || ''}, ${s['Destination Country'] || ''}</td>
                    <td>${s['Transport Mode'] || ''}</td>
                    <td>${s['Shipper'] || ''}</td>
                    <td>${(s.weight || 0).toFixed(2)}</td>
                    <td>¬£${(s.cost || 0).toFixed(2)}</td>
                    <td>${(s.co2 || 0).toFixed(2)}</td>
                    <td>${(s.distance || 0).toFixed(2)}</td>
                    <td>¬£${(s.efficiency || 0).toFixed(3)}/km</td>
                </tr>
            `).join('');
        }

        // Update record count
        function updateRecordCount() {
            document.getElementById('recordCount').textContent = 
                `Showing ${filteredData.length} of ${shipmentData.length} records`;
        }

        // Export to CSV (comprehensive analysis)
        function exportToCSV() {
            // Calculate summary statistics
            const totalShipments = filteredData.length;
            const totalCO2 = filteredData.reduce((sum, s) => sum + s.co2, 0);
            const totalCost = filteredData.reduce((sum, s) => sum + s.cost, 0);
            const totalWeight = filteredData.reduce((sum, s) => sum + s.weight, 0);
            const totalDistance = filteredData.reduce((sum, s) => sum + s.distance, 0);
            
            // Transport mode analysis
            const transportAnalysis = {};
            filteredData.forEach(s => {
                const mode = s['Transport Mode'] || 'Unknown';
                if (!transportAnalysis[mode]) {
                    transportAnalysis[mode] = {
                        count: 0,
                        totalCost: 0,
                        totalCO2: 0,
                        totalWeight: 0,
                        totalDistance: 0
                    };
                }
                transportAnalysis[mode].count++;
                transportAnalysis[mode].totalCost += s.cost;
                transportAnalysis[mode].totalCO2 += s.co2;
                transportAnalysis[mode].totalWeight += s.weight;
                transportAnalysis[mode].totalDistance += s.distance;
            });
            
            // Route analysis
            const routeAnalysis = {};
            filteredData.forEach(s => {
                const route = `${s['Origin Country']} -> ${s['Destination Country']}`;
                if (!routeAnalysis[route]) {
                    routeAnalysis[route] = {
                        count: 0,
                        totalCost: 0,
                        totalCO2: 0,
                        totalWeight: 0,
                        totalDistance: 0
                    };
                }
                routeAnalysis[route].count++;
                routeAnalysis[route].totalCost += s.cost;
                routeAnalysis[route].totalCO2 += s.co2;
                routeAnalysis[route].totalWeight += s.weight;
                routeAnalysis[route].totalDistance += s.distance;
            });
            
            // Create CSV content
            let csvContent = '';
            
            // Summary section
            csvContent += 'SHIPMENT ANALYSIS SUMMARY\n';
            csvContent += `Generated Date,${new Date().toISOString()}\n`;
            csvContent += `Total Shipments,${totalShipments}\n`;
            csvContent += `Total Cost,¬£${totalCost.toFixed(2)}\n`;
            csvContent += `Total Weight,${totalWeight.toFixed(2)} kg\n`;
            csvContent += `Total Distance,${totalDistance.toFixed(2)} km\n`;
            csvContent += `Total CO2 Emissions,${totalCO2.toFixed(2)} kg\n`;
            csvContent += `Average Cost per Shipment,¬£${(totalCost / totalShipments).toFixed(2)}\n`;
            csvContent += `Average CO2 per Shipment,${(totalCO2 / totalShipments).toFixed(2)} kg\n`;
            csvContent += `Average Cost per km,¬£${(totalCost / totalDistance).toFixed(3)}\n`;
            csvContent += `CO2 per kg Shipped,${(totalCO2 / totalWeight).toFixed(3)} kg\n\n`;
            
            // Transport mode analysis
            csvContent += 'TRANSPORT MODE ANALYSIS\n';
            csvContent += 'Mode,Shipments,Total Cost,Total CO2,Total Weight,Total Distance,Avg Cost/Shipment,Avg CO2/Shipment\n';
            Object.entries(transportAnalysis).forEach(([mode, data]) => {
                csvContent += `${mode},${data.count},${data.totalCost.toFixed(2)},${data.totalCO2.toFixed(2)} kg,${data.totalWeight.toFixed(2)} kg,${data.totalDistance.toFixed(2)} km,${(data.totalCost / data.count).toFixed(2)},${(data.totalCO2 / data.count).toFixed(2)} kg\n`;
            });
            csvContent += '\n';
            
            // Top 10 routes analysis
            csvContent += 'TOP 10 ROUTES ANALYSIS\n';
            csvContent += 'Route,Shipments,Total Cost,Total CO2,Total Weight,Total Distance,Avg Cost/Shipment,Avg CO2/Shipment\n';
            const topRoutes = Object.entries(routeAnalysis)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 10);
            topRoutes.forEach(([route, data]) => {
                csvContent += `"${route}",${data.count},${data.totalCost.toFixed(2)},${data.totalCO2.toFixed(2)} kg,${data.totalWeight.toFixed(2)} kg,${data.totalDistance.toFixed(2)} km,${(data.totalCost / data.count).toFixed(2)},${(data.totalCO2 / data.count).toFixed(2)} kg\n`;
            });
            csvContent += '\n';
            
            // Detailed shipment data
            csvContent += 'DETAILED SHIPMENT DATA\n';
            csvContent += 'ID,Date,Origin,Destination,Mode,Shipper,Weight (kg),Cost (¬£),CO2 (kg),Distance (km),Cost/km,Emission Type,Emission Factor\n';
            filteredData.forEach(s => {
                csvContent += `"${s['Unique identifier']}","${s['Shipping Date']}","${s['Collection Area Name']}, ${s['Origin Country']}","${s['Delivery Area Name']}, ${s['Destination Country']}","${s['Transport Mode']}","${s['Shipper']}",${s.weight.toFixed(2)},¬£${s.cost.toFixed(2)},${s.co2.toFixed(2)},${s.distance.toFixed(2)},¬£${s.efficiency.toFixed(3)},"${s['Emission type by shipper mode']}",${s['Emission factor of emission type']}\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `shipment_analysis_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('Full analysis exported successfully!');
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeFilters();
        });

        // Close recommendations modal
        function closeRecommendations() {
            document.getElementById('recommendationResults').style.display = 'none';
        }

        // Populate route selection dropdowns
        function populateRouteSelectors() {
            const origins = [...new Set(shipmentData.map(s => s['Origin Country']))].sort();
            const destinations = [...new Set(shipmentData.map(s => s['Destination Country']))].sort();
            
            const originSelect = document.getElementById('routeOriginSelect');
            const destSelect = document.getElementById('routeDestSelect');
            
            originSelect.innerHTML = '<option value="">All Origins</option>';
            origins.forEach(country => {
                originSelect.innerHTML += `<option value="${country}">${country}</option>`;
            });
            
            destSelect.innerHTML = '<option value="">All Destinations</option>';
            destinations.forEach(country => {
                destSelect.innerHTML += `<option value="${country}">${country}</option>`;
            });
            
            // Add change listeners
            originSelect.addEventListener('change', updateSelectedRouteInfo);
            destSelect.addEventListener('change', updateSelectedRouteInfo);
        }

        // Update selected route info
        function updateSelectedRouteInfo() {
            const origin = document.getElementById('routeOriginSelect').value;
            const dest = document.getElementById('routeDestSelect').value;
            const infoDiv = document.getElementById('selectedRoutesInfo');
            const infoText = document.getElementById('selectedRouteText');
            
            if (origin || dest) {
                infoDiv.style.display = 'block';
                let routeText = '';
                if (origin && dest) {
                    routeText = `${origin} ‚Üí ${dest}`;
                } else if (origin) {
                    routeText = `All routes from ${origin}`;
                } else if (dest) {
                    routeText = `All routes to ${dest}`;
                }
                infoText.textContent = routeText;
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // Analyze selected routes
        async function analyzeSelectedRoutes() {
            const origin = document.getElementById('routeOriginSelect').value;
            const dest = document.getElementById('routeDestSelect').value;
            
            if (!origin && !dest) {
                alert('Please select at least an origin or destination country');
                return;
            }
            
            await analyzeRouteOptimization(origin, dest);
        }


        function getCountryCode(country) {
            const codes = {
                'United Kingdom': 'GB',
                'UNITED KINGDOM': 'GB',
                'UK': 'GB',
                'United States': 'US',
                'UNITED STATES': 'US',
                'USA': 'US',
                'Germany': 'DE',
                'GERMANY': 'DE',
                'France': 'FR',
                'FRANCE': 'FR',
                'Spain': 'ES',
                'SPAIN': 'ES',
                'Italy': 'IT',
                'ITALY': 'IT',
                'Canada': 'CA',
                'CANADA': 'CA',
                'Australia': 'AU',
                'AUSTRALIA': 'AU',
                'Japan': 'JP',
                'JAPAN': 'JP',
                'China': 'CN',
                'CHINA': 'CN',
                'Netherlands': 'NL',
                'NETHERLANDS': 'NL',
                'Belgium': 'BE',
                'BELGIUM': 'BE',
                'Switzerland': 'CH',
                'SWITZERLAND': 'CH',
                'Sweden': 'SE',
                'SWEDEN': 'SE',
                'Norway': 'NO',
                'NORWAY': 'NO',
                'Denmark': 'DK',
                'DENMARK': 'DK',
                'Finland': 'FI',
                'FINLAND': 'FI',
                'Ireland': 'IE',
                'IRELAND': 'IE',
                'Poland': 'PL',
                'POLAND': 'PL',
                'Czech Republic': 'CZ',
                'CZECH REPUBLIC': 'CZ',
                'Austria': 'AT',
                'AUSTRIA': 'AT',
                'Portugal': 'PT',
                'PORTUGAL': 'PT',
                'Greece': 'GR',
                'GREECE': 'GR',
                'India': 'IN',
                'INDIA': 'IN',
                'Brazil': 'BR',
                'BRAZIL': 'BR',
                'Mexico': 'MX',
                'MEXICO': 'MX',
                'Singapore': 'SG',
                'SINGAPORE': 'SG',
                'Malaysia': 'MY',
                'MALAYSIA': 'MY',
                'Thailand': 'TH',
                'THAILAND': 'TH',
                'Indonesia': 'ID',
                'INDONESIA': 'ID',
                'Philippines': 'PH',
                'PHILIPPINES': 'PH',
                'New Zealand': 'NZ',
                'NEW ZEALAND': 'NZ',
                'Israel': 'IL',
                'ISRAEL': 'IL',
                'UAE': 'AE',
                'United Arab Emirates': 'AE',
                'UNITED ARAB EMIRATES': 'AE',
                'Saudi Arabia': 'SA',
                'SAUDI ARABIA': 'SA',
                'South Africa': 'ZA',
                'SOUTH AFRICA': 'ZA',
                'Turkey': 'TR',
                'TURKEY': 'TR',
                'Russia': 'RU',
                'RUSSIA': 'RU',
                'South Korea': 'KR',
                'SOUTH KOREA': 'KR',
                'Hong Kong': 'HK',
                'HONG KONG': 'HK',
                'Taiwan': 'TW',
                'TAIWAN': 'TW'
            };
            
            // Try exact match first
            if (codes[country]) {
                return codes[country];
            }
            
            // Try case-insensitive match
            const upperCountry = country.toUpperCase();
            for (const [key, value] of Object.entries(codes)) {
                if (key.toUpperCase() === upperCountry) {
                    return value;
                }
            }
            
            // Return first two letters as fallback
            console.warn(`Country code not found for: ${country}, using fallback`);
            return country.substring(0, 2).toUpperCase();
        }

        // Helper function for generic postcodes
        function getGenericPostcode(countryCode) {
            const genericPostcodes = {
                'GB': 'SW1A 1AA',  // London
                'US': '10001',     // New York
                'DE': '10115',     // Berlin
                'FR': '75001',     // Paris
                'ES': '28001',     // Madrid
                'IT': '00100',     // Rome
                'CA': 'M5H 2N2',   // Toronto
                'AU': '2000',      // Sydney
                'JP': '100-0001',  // Tokyo
                'CN': '100000',    // Beijing
                'NL': '1011',      // Amsterdam
                'BE': '1000',      // Brussels
                'CH': '8001',      // Zurich
                'SE': '111 21',    // Stockholm
                'NO': '0001',      // Oslo
                'DK': '1000',      // Copenhagen
                'IN': '110001',    // New Delhi
                'BR': '01000-000', // S√£o Paulo
                'MX': '01000',     // Mexico City
                'SG': '018956',    // Singapore
                'MY': '50450',     // Kuala Lumpur
                'HK': '999077',    // Hong Kong
                'AE': '00000',     // Dubai (UAE doesn't use postal codes)
            };
            return genericPostcodes[countryCode] || '10001';
        }

        // Get next business day
        function getNextBusinessDay() {
            const date = new Date();
            date.setDate(date.getDate() + 1);
            if (date.getDay() === 0) date.setDate(date.getDate() + 1); // Skip Sunday
            if (date.getDay() === 6) date.setDate(date.getDate() + 2); // Skip Saturday
            return date.toISOString().split('T')[0];
        }


        // Update the existing analyzeRouteOptimization function
        async function analyzeRouteOptimization(selectedOrigin = null, selectedDest = null) {
            const btn = document.getElementById('analyzeBtn');
            const loader = document.getElementById('recommendationLoader');
            const resultsDiv = document.getElementById('recommendationResults');
            const contentDiv = document.getElementById('recommendationContent');
            
            populateRouteSelectors();
            
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            resultsDiv.style.display = 'flex';
            loader.style.display = 'flex';
            contentDiv.innerHTML = '';
            
            try {
                // Calculate top 10 routes by total cost
                const routeAnalysis = {};
                
                let ukusDebugTotal = 0;
                let ukusDebugCount = 0;

                shipmentData.forEach(s => {
                    const routeKey = `${s['Origin Country']}|||${s['Destination Country']}`;
                    const weight = parseFloat(s['Weight']) || 0;
                    const cost = parseFloat(s['Cost of shipment']) || 0;
                    
                    // Debug UK->US totals
                    if (s['Origin Country'] === 'UNITED KINGDOM' && s['Destination Country'] === 'UNITED STATES') {
                        ukusDebugTotal += cost;
                        ukusDebugCount++;
                        if (ukusDebugCount <= 5 || ukusDebugCount > 204) {
                            console.log(`UK->US #${ukusDebugCount}: ${s['Cost of shipment']} -> Running total: ${ukusDebugTotal.toFixed(2)}`);
                        }
                    }
                    
                    if (!routeAnalysis[routeKey]) {
                        routeAnalysis[routeKey] = {
                            from: s['Origin Country'],
                            to: s['Destination Country'],
                            shipments: [],
                            totalCost: 0,
                            totalWeight: 0,
                            totalCO2: 0,
                            count: 0,
                            isInternational: s['Origin Country'] !== s['Destination Country']
                        };
                    }
                    
                    routeAnalysis[routeKey].shipments.push({
                        ...s,
                        weight: weight,
                        cost: cost,
                        co2: s.co2 || 0
                    });
                    routeAnalysis[routeKey].totalCost += cost;
                    routeAnalysis[routeKey].totalWeight += weight;
                    routeAnalysis[routeKey].totalCO2 += (s.co2 || 0);
                    routeAnalysis[routeKey].count++;
                });

                console.log(`UK->US Final Debug Total: ${ukusDebugTotal.toFixed(2)} from ${ukusDebugCount} shipments`);
                console.log('UK->US Route Analysis Total:', routeAnalysis['UNITED KINGDOM|||UNITED STATES']?.totalCost);

            // Add this after the forEach to check the total
            console.log('UK->US Route Analysis:', routeAnalysis['UNITED KINGDOM|||UNITED STATES']);
                
                // Get top 10 routes by total cost
                const topRoutes = Object.entries(routeAnalysis)
                    .sort((a, b) => b[1].totalCost - a[1].totalCost)
                    .slice(0, 10);
                
                console.log('Top 10 routes by cost:', topRoutes);
                
                // Show top 10 routes overview first
                let html = `
                    <div style="background: #e8f5e9; padding: 20px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <h4 style="margin-top: 0; color: #2e7d32;">üîí Your Data is Protected</h4>
                        <p style="margin: 10px 0; color: #2e7d32;">
                            We analyze your shipments locally and only send generic weight queries to get market rates.
                        </p>
                    </div>
                    
                    <h3>Top 10 Routes by Total Cost</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">Click on any route to see detailed cost optimization analysis</p>
                    
                    <div style="display: grid; gap: 15px; margin-bottom: 30px;">
                `;
                
                topRoutes.forEach(([routeKey, data], index) => {
                    const avgCost = data.totalCost / data.count;
                    const avgWeight = data.totalWeight / data.count;
                    
                    html += `
                        <div class="route-overview-card" 
                            style="background: white; padding: 20px; border-radius: 8px; 
                                    border-left: 4px solid #3498db; cursor: pointer; 
                                    transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"
                            onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 10px rgba(0,0,0,0.15)';"
                            onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.1)';"
                            onclick="analyzeSpecificRoute('${data.from}', '${data.to}')">
                            
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 10px 0; color: #2c3e50;">
                                        #${index + 1} ${data.from} ‚Üí ${data.to} ${data.isInternational ? 'üåç' : 'üè†'}
                                    </h4>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; font-size: 14px;">
                                        <div>
                                            <span style="color: #7f8c8d;">Shipments:</span><br>
                                            <strong>${data.count}</strong>
                                        </div>
                                        <div>
                                            <span style="color: #7f8c8d;">Total Cost:</span><br>
                                            <strong>¬£${data.totalCost.toFixed(2)}</strong>
                                        </div>
                                        <div>
                                            <span style="color: #7f8c8d;">Avg Cost:</span><br>
                                            <strong>¬£${avgCost.toFixed(2)}</strong>
                                        </div>
                                        <div>
                                            <span style="color: #7f8c8d;">Avg Weight:</span><br>
                                            <strong>${avgWeight.toFixed(1)}kg</strong>
                                        </div>
                                    </div>
                                </div>
                                <div style="font-size: 24px; color: #3498db;">
                                    ‚Üí
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    </div>
                    
                    <div id="specificRouteAnalysis" style="display: none;">
                        <!-- Specific route analysis will be shown here -->
                    </div>
                `;
                
                contentDiv.innerHTML = html;
                loader.style.display = 'none';
                
            } catch (error) {
                console.error('Error in analyzeRouteOptimization:', error);
                contentDiv.innerHTML = '<div class="error-message">Failed to analyze routes. Error: ' + error.message + '</div>';
                loader.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.textContent = 'üí° Analyze Cost Optimization';
            }
        }


        async function analyzeSpecificRoute(origin, destination) {
            const analysisDiv = document.getElementById('specificRouteAnalysis');
            analysisDiv.style.display = 'block';
            analysisDiv.innerHTML = '<div class="loader-spinner" style="margin: 20px auto;"></div><p style="text-align: center;">Analyzing route and fetching market rates...</p>';
            
            // Scroll to analysis
            analysisDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            try {
                // Get shipments for this specific route
                const routeShipments = shipmentData.filter(s => 
                    s['Origin Country'] === origin && s['Destination Country'] === destination
                );
                
                console.log(`Analyzing ${origin} ‚Üí ${destination}: ${routeShipments.length} shipments`);
                
                // Calculate statistics
                const weights = routeShipments.map(s => parseFloat(s['Weight']) || 0).sort((a, b) => a - b);
                const costs = routeShipments.map(s => parseFloat(s['Cost of shipment']) || 0).sort((a, b) => a - b);
                const stats = {
                    count: routeShipments.length,
                    totalCost: costs.reduce((sum, c) => sum + c, 0),
                    totalWeight: weights.reduce((sum, w) => sum + w, 0),
                    avgCost: costs.reduce((sum, c) => sum + c, 0) / costs.length,
                    avgWeight: weights.reduce((sum, w) => sum + w, 0) / weights.length,
                    minWeight: weights[0],
                    maxWeight: weights[weights.length - 1],
                    minCost: costs[0],
                    maxCost: costs[costs.length - 1],
                    medianWeight: weights[Math.floor(weights.length / 2)],
                    medianCost: costs[Math.floor(costs.length / 2)],
                    p25Weight: weights[Math.floor(weights.length * 0.25)],
                    p75Weight: weights[Math.floor(weights.length * 0.75)],
                    p25Cost: costs[Math.floor(costs.length * 0.25)],
                    p75Cost: costs[Math.floor(costs.length * 0.75)]
                };
                
                // Get market rates for different weight points
 // Get market rates for different weight points
 const originCode = getCountryCode(origin);
                const destinationCode = getCountryCode(destination);
                const isInternational = origin !== destination;
                
                console.log(`Country codes: ${origin} (${originCode}) ‚Üí ${destination} (${destinationCode})`);
                
                // Calculate current cost per kg
                const currentCostPerKg = stats.avgCost / stats.avgWeight;
                console.log(`Current cost per kg: ¬£${currentCostPerKg.toFixed(3)}`);
                
                // Use a fixed reference weight for all API calls to ensure consistency
                const REFERENCE_WEIGHT = 1; // 1kg reference weight for pure cost per kg calculation
                
                // Check rates for reference weight
                const apiData = {
                    collection_country: originCode,
                    delivery_country: destinationCode,
                    weight: REFERENCE_WEIGHT,
                    currentCost: REFERENCE_WEIGHT * currentCostPerKg, // Expected cost for reference weight
                    isInternational: isInternational
                };
                
                console.log('Fetching rates for reference weight:', apiData);
                const rates = await getParcelMonkeyRates(apiData);
                console.log('Received rates:', rates);
                
                // Convert rates to cost per kg based on reference weight, then multiply by actual avg weight
                if (rates && rates.length > 0) {
                    rates.forEach(rate => {
                        // Calculate cost per kg from the reference weight quote
                        rate.costPerKg = rate.price / REFERENCE_WEIGHT;
                        // Apply to actual average weight
                        rate.estimatedAvgShipmentCost = rate.costPerKg * stats.avgWeight;
                        rate.originalPrice = rate.price;
                        rate.referenceWeight = REFERENCE_WEIGHT;
                    });
                    
                    // Sort by estimated average shipment cost
                    rates.sort((a, b) => a.estimatedAvgShipmentCost - b.estimatedAvgShipmentCost);
                }
                
                // Calculate potential savings
                let savings = {
                    perShipment: 0,
                    monthly: 0,
                    annually: 0,
                    percentage: 0
                };
                
                if (rates && rates.length > 0) {
                    const bestPrice = rates[0].price;
                    savings.perShipment = Math.max(0, stats.avgCost - rates[0].estimatedAvgShipmentCost);
                    savings.currentCostPerKg = currentCostPerKg;
                    savings.bestCostPerKg = rates[0].costPerKg;
                    savings.monthly = savings.perShipment * stats.count;
                    savings.annually = savings.monthly * 12;
                    savings.percentage = stats.avgCost > 0 ? (savings.perShipment / stats.avgCost * 100) : 0;
                }
                
                // Display detailed analysis
                let html = `
                    <div style="border-top: 2px solid #e0e0e0; margin-top: 30px; padding-top: 30px;">
                        <h3>Detailed Analysis: ${origin} ‚Üí ${destination}</h3>
                        
                        <div class="recommendation-summary" style="margin-bottom: 30px;">
                            <div class="recommendation-card">
                                <h4>Potential Monthly Savings</h4>
                                <div class="amount">¬£${savings.monthly.toFixed(2)}</div>
                            </div>
                            <div class="recommendation-card">
                                <h4>Savings Per Shipment</h4>
                                <div class="amount">¬£${savings.perShipment.toFixed(2)}</div>
                            </div>
                            <div class="recommendation-card">
                                <h4>Savings Percentage</h4>
                                <div class="amount">${savings.percentage.toFixed(1)}%</div>
                            </div>
                            <div class="recommendation-card">
                                <h4>Annual Savings</h4>
                                <div class="amount">¬£${savings.annually.toFixed(0)}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <h4 style="margin-top: 0;">Shipment Statistics</h4>
                                <table style="width: 100%; font-size: 14px;">
                                    <tr><td>Total Shipments:</td><td><strong>${stats.count}</strong></td></tr>
                                    <tr><td>Total Cost:</td><td><strong>¬£${stats.totalCost.toFixed(2)}</strong></td></tr>
                                    <tr><td>Average Cost:</td><td><strong>¬£${stats.avgCost.toFixed(2)}</strong></td></tr>
                                    <tr><td>Cost Range:</td><td>¬£${stats.minCost.toFixed(2)} - ¬£${stats.maxCost.toFixed(2)}</td></tr>
                                    <tr><td>Median Cost:</td><td>¬£${stats.medianCost.toFixed(2)}</td></tr>
                                </table>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                                <h4 style="margin-top: 0;">Weight Distribution</h4>
                                <table style="width: 100%; font-size: 14px;">
                                    <tr><td>Average Weight:</td><td><strong>${stats.avgWeight.toFixed(1)}kg</strong></td></tr>
                                    <tr><td>Weight Range:</td><td>${stats.minWeight.toFixed(1)}kg - ${stats.maxWeight.toFixed(1)}kg</td></tr>
                                    <tr><td>Median Weight:</td><td>${stats.medianWeight.toFixed(1)}kg</td></tr>
                                    <tr><td>25th Percentile:</td><td>${stats.p25Weight.toFixed(1)}kg</td></tr>
                                    <tr><td>75th Percentile:</td><td>${stats.p75Weight.toFixed(1)}kg</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <h4>Market Rate Comparison</h4>
                        <p style="color: #7f8c8d; margin-bottom: 15px;">
                            Cost per kg analysis for your average shipment weight (${stats.avgWeight.toFixed(1)}kg)
                        </p>
                        
                        <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <strong>Current Performance:</strong>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px;">
                                <div>‚Ä¢ Your cost per kg: <strong>¬£${currentCostPerKg.toFixed(3)}/kg</strong></div>
                                <div>‚Ä¢ Your cost per kg √ó your average weight: <strong>¬£${currentCostPerKg.toFixed(3)}/kg √ó ${stats.avgWeight.toFixed(1)}kg = ¬£${stats.avgCost.toFixed(2)}</strong></div>
                            </div>
                        </div>
                        
                        <table class="comparison-table" style="width: 100%; margin-bottom: 30px;">
                            <thead>
                                <tr>
                                    <th>Carrier</th>
                                    <th>Service</th>
                                    <th>Cost per kg</th>
                                    <th>Est. Avg Shipment</th>
                                    <th>Transit Time</th>
                                    <th>Savings vs Current</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #e3f2fd;">
                                    <td><strong>Your Current Average</strong></td>
                                    <td>Current Service</td>
                                    <td><strong>¬£${currentCostPerKg.toFixed(3)}/kg</strong></td>
                                    <td><strong>¬£${stats.avgCost.toFixed(2)}</strong><br><small>(¬£${currentCostPerKg.toFixed(3)} √ó ${stats.avgWeight.toFixed(1)}kg)</small></td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                `;
                
                if (rates && rates.length > 0) {
                    rates.forEach((rate, index) => {
                        const saving = stats.avgCost - rate.estimatedAvgShipmentCost;
                        const savingPercent = stats.avgCost > 0 ? (saving / stats.avgCost * 100) : 0;
                        const highlight = index === 0 && saving > 0 ? 'style="background: #d4edda;"' : '';
                        
                        html += `
                            <tr ${highlight}>
                                <td>${rate.carrier}</td>
                                <td>${rate.service}</td>
                                <td>¬£${rate.costPerKg.toFixed(3)}/kg</td>
                                <td>¬£${rate.estimatedAvgShipmentCost.toFixed(2)}<br><small>(¬£${rate.costPerKg.toFixed(3)} √ó ${stats.avgWeight.toFixed(1)}kg)</small></td>
                                <td>${rate.transit}</td>
                                <td>${saving > 0 ? `¬£${saving.toFixed(2)} (${savingPercent.toFixed(1)}%)` : '-'}</td>
                            </tr>
                        `;
                    });
                    
                    // Add note about the calculation
                    html += `
                        </tbody>
                        </table>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
                            <strong>üìä How we calculate and compare:</strong>
                            <p style="margin: 10px 0;">
                                ‚Ä¢ <strong>Your cost per kg √ó your average weight</strong> = ¬£${currentCostPerKg.toFixed(3)}/kg √ó ${stats.avgWeight.toFixed(1)}kg = ¬£${stats.avgCost.toFixed(2)}<br>
                                ‚Ä¢ <strong>Market cost per kg √ó your average weight</strong> = Market rate/kg √ó ${stats.avgWeight.toFixed(1)}kg = Estimated cost
                            </p>
                            <p style="margin: 10px 0 0 0;">
                                We get quotes for 1kg shipments (pure cost per kg), then multiply by your average weight for fair comparison.
                            </p>
                        </div>
                    `;
                } else {
                    html += `
                        <tr>
                            <td colspan="5" style="text-align: center; color: #7f8c8d;">
                                Unable to fetch market rates. Please check your connection and try again.
                            </td>
                        </tr>
                    `;
                }
                
                html += `
                            </tbody>
                        </table>
                        
                        ${savings.monthly > 0 ? `
                            <div style="background: #d4edda; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin-top: 0;">üí° Recommendation</h4>
                                <p>Switch to <strong>${rates[0].carrier}</strong> for this route to save:</p>
                                <ul>
                                    <li>¬£${savings.perShipment.toFixed(2)} per shipment</li>
                                    <li>¬£${savings.monthly.toFixed(2)} per month</li>
                                    <li>¬£${savings.annually.toFixed(0)} per year</li>
                                </ul>
                                <p style="margin-bottom: 0;">This represents a ${savings.percentage.toFixed(1)}% cost reduction for this route.</p>
                            </div>
                        ` : `
                            <div style="background: #f8d7da; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin-top: 0;">‚úì Good News</h4>
                                <p>Your current rates are already competitive for this route!</p>
                                <p style="margin-bottom: 0;">Continue monitoring the market for future opportunities.</p>
                            </div>
                        `}
                        
                        <button class="btn btn-primary" onclick="document.getElementById('specificRouteAnalysis').style.display='none'">
                            ‚Üê Back to Top Routes
                        </button>
                    </div>
                `;
                
                analysisDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error analyzing specific route:', error);
                analysisDiv.innerHTML = `
                    <div class="error-message">
                        Failed to analyze route: ${error.message}
                    </div>
                    <button class="btn btn-primary" onclick="document.getElementById('specificRouteAnalysis').style.display='none'">
                        ‚Üê Back to Top Routes
                    </button>
                `;
            }
        }




        // Fixed ParcelMonkey API call with better error handling

        async function getParcelMonkeyRates(data) {
            try {
                console.log('Fetching rates via backend proxy:', data);
                
                // Your backend URL
                const BACKEND_URL = 'https://shipment-dashboard-api.onrender.com';
                
                // Prepare request payload
                const payload = {
                    collection_country: data.collection_country,
                    delivery_country: data.delivery_country,
                    weight: Math.max(1, Math.round(data.weight)),
                    collection_postcode: getGenericPostcode(data.collection_country),
                    delivery_postcode: getGenericPostcode(data.delivery_country),
                    currentCost: data.currentCost // Add this for better fallback rates
                };
                
                console.log('Sending request to backend:', payload);
                
                // Call backend proxy
                const response = await fetch(`${BACKEND_URL}/api/shipping-rates`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Backend responded with status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Backend response:', result);
                
                if (result.rates && result.rates.length > 0) {
                    console.log('‚úì Got rates from backend!');
                    
                    // If using fallback rates, adjust based on current cost
                    if (!result.success && data.currentCost) {
                        return result.rates.map(rate => ({
                            ...rate,
                            price: data.currentCost * (rate.price / 100) // Convert from base price to actual
                        }));
                    }
                    
                    return result.rates;
                } else {
                    throw new Error('No rates available');
                }
                
            } catch (error) {
                console.error('Error fetching rates from backend:', error);
                return getTestRates(data); // Your existing fallback
            }
        }


        // Update route selectors for the optional filtering
        function populateRouteSelectors() {
            const origins = [...new Set(shipmentData.map(s => s['Origin Country']))].sort();
            const destinations = [...new Set(shipmentData.map(s => s['Destination Country']))].sort();
            
            const originSelect = document.getElementById('routeOriginSelect');
            const destSelect = document.getElementById('routeDestSelect');
            
            if (originSelect) {
                originSelect.innerHTML = '<option value="">All Origins</option>';
                origins.forEach(country => {
                    originSelect.innerHTML += `<option value="${country}">${country}</option>`;
                });
            }
            
            if (destSelect) {
                destSelect.innerHTML = '<option value="">All Destinations</option>';
                destinations.forEach(country => {
                    destSelect.innerHTML += `<option value="${country}">${country}</option>`;
                });
            }
        }

        // Close recommendations modal
        function closeRecommendations() {
            document.getElementById('recommendationResults').style.display = 'none';
        }

        // Handle route selection in the optional filters
        async function analyzeSelectedRoutes() {
            const origin = document.getElementById('routeOriginSelect').value;
            const dest = document.getElementById('routeDestSelect').value;
            
            if (origin && dest) {
                // If both are selected, analyze that specific route directly
                await analyzeSpecificRoute(origin, dest);
            } else {
                // Otherwise show the top 10 routes
                await analyzeRouteOptimization(origin, dest);
            }
        }

        // Check backend connection when page loads
        async function checkBackendConnection() {
            try {
                const BACKEND_URL = 'https://shipment-dashboard-api.onrender.com';
                const response = await fetch(`${BACKEND_URL}/api/health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    console.log('‚úì Backend proxy is connected:', data);
                    return true;
                }
            } catch (error) {
                console.error('‚úó Backend proxy is not available:', error.message);
                console.log('‚ö†Ô∏è Will use fallback rates for pricing');
                return false;
            }
        }

        // Check on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const backendAvailable = await checkBackendConnection();
            if (!backendAvailable) {
                console.warn('Backend pricing service is unavailable. Using estimated rates.');
            }
        });

        // Updated display function to show all comparisons
        function displayDetailedRecommendations(recommendations, totalSavings, analyzedCost, totalShipments) {
            const contentDiv = document.getElementById('recommendationContent');
            const existingContent = contentDiv.innerHTML;
            
            const savingsPercentage = analyzedCost > 0 ? (totalSavings / analyzedCost * 100).toFixed(1) : 0;
            const projectedAnnualSavings = totalSavings * 12;
            
            let html = existingContent + `
                <div class="recommendation-summary">
                    <div class="recommendation-card">
                        <h4>Potential Monthly Savings</h4>
                        <div class="amount">¬£${totalSavings.toFixed(2)}</div>
                    </div>
                    <div class="recommendation-card">
                        <h4>Savings Percentage</h4>
                        <div class="amount">${savingsPercentage}%</div>
                    </div>
                    <div class="recommendation-card">
                        <h4>Projected Annual Savings</h4>
                        <div class="amount">¬£${projectedAnnualSavings.toFixed(0)}</div>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 20px;">Top 10 Routes Analysis:</h3>
            `;
            
            // Show all routes, even those without savings
            recommendations.forEach((rec, index) => {
                const savingsClass = rec.hasSavings ? 'savings' : 'no-savings';
                const badgeClass = rec.hasSavings ? 'savings-badge' : 'no-savings-badge';
                const badgeText = rec.hasSavings 
                    ? `Save ¬£${rec.estimatedSavings.totalSavings.toFixed(2)}/month`
                    : 'Current rates competitive';
                
                html += `
                    <div class="route-recommendation ${savingsClass}">
                        <div class="route-header">
                            <h5>#${index + 1} ${rec.route} ${rec.isInternational ? 'üåç' : 'üè†'}</h5>
                            <span class="${badgeClass}">${badgeText}</span>
                        </div>
                        
                        <p style="color: #7f8c8d; margin-bottom: 15px;">
                            ${rec.shipmentCount} shipments | Total spend: ¬£${rec.currentTotalCost.toFixed(2)} | 
                            Average per shipment: ¬£${rec.currentAvgCost.toFixed(2)}
                        </p>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <strong>Shipment Profile:</strong>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; font-size: 14px;">
                                <div>Weight range: ${rec.weightDistribution.p25.toFixed(1)}kg - ${rec.weightDistribution.p75.toFixed(1)}kg</div>
                                <div>Median weight: ${rec.weightDistribution.p50.toFixed(1)}kg</div>
                                <div>Cost range: ¬£${rec.costDistribution.p25.toFixed(2)} - ¬£${rec.costDistribution.p75.toFixed(2)}</div>
                                <div>Median cost: ¬£${rec.costDistribution.p50.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>Carrier</th>
                                    <th>Service</th>
                                    <th>Price (per shipment)</th>
                                    <th>Transit Time</th>
                                    <th>Potential Savings</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #e3f2fd;">
                                    <td><strong>Your Current Average</strong></td>
                                    <td>Current Service</td>
                                    <td><strong>¬£${rec.currentAvgCost.toFixed(2)}</strong></td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                                ${rec.alternatives.map((alt, altIndex) => {
                                    const savings = rec.currentAvgCost - alt.price;
                                    const savingsPercent = (savings / rec.currentAvgCost * 100).toFixed(1);
                                    const rowClass = altIndex === 0 && savings > 0 ? 'highlight' : '';
                                    return `
                                        <tr class="${rowClass}">
                                            <td>${alt.carrier}</td>
                                            <td>${alt.service}</td>
                                            <td>¬£${alt.price.toFixed(2)}</td>
                                            <td>${alt.transit}</td>
                                            <td>${savings > 0 ? `¬£${savings.toFixed(2)} (${savingsPercent}%)` : '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        
                        ${rec.hasSavings ? `
                            <div style="margin-top: 15px; padding: 10px; background: #d4edda; border-radius: 6px; font-size: 14px;">
                                <strong>üí° Recommendation:</strong> Switch to ${rec.alternatives[0].carrier} for this route to save 
                                ¬£${rec.estimatedSavings.avgSavingsPerShipment.toFixed(2)} per shipment 
                                (¬£${rec.estimatedSavings.totalSavings.toFixed(2)}/month)
                            </div>
                        ` : `
                            <div style="margin-top: 15px; padding: 10px; background: #f8d7da; border-radius: 6px; font-size: 14px;">
                                <strong>‚úì Good news:</strong> Your current rates are already competitive for this route!
                            </div>
                        `}
                    </div>
                `;
            });
            
            html += `
                <div class="recommendation-footer">
                    <strong>Analysis Summary:</strong>
                    <ul style="margin-top: 10px; font-size: 14px;">
                        <li>Analyzed top ${recommendations.length} routes by spend</li>
                        <li>Total analyzed cost: ¬£${analyzedCost.toFixed(2)}</li>
                        <li>Routes with savings opportunities: ${recommendations.filter(r => r.hasSavings).length}</li>
                        <li>Routes with competitive rates: ${recommendations.filter(r => !r.hasSavings).length}</li>
                        ${totalSavings > 0 ? `<li><strong>Total potential savings: ¬£${totalSavings.toFixed(2)}/month (¬£${projectedAnnualSavings.toFixed(0)}/year)</strong></li>` : ''}
                    </ul>
                    <br>
                    <em>Note: Prices shown are estimates based on average shipment weights. Actual savings may vary based on specific shipment characteristics and negotiated rates.</em>                </div>
            `;
            
            contentDiv.innerHTML = html;
        }



        </script>
</body>
</html>